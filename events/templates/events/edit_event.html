{% extends 'base.html' %}

{% block content %}
<div class="event-form-container">
  <div class="event-form-header">
    <h1 class="page-title">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 10px; vertical-align: middle;">
        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
      </svg>
      Редактирование мероприятия
    </h1>
    <div class="event-id">
      <span class="id-label">ID:</span>
      <span class="id-value">{{ event.id }}</span>
    </div>
  </div>

  <div class="event-form-card">
    <form method="POST" class="event-form">
      {% csrf_token %}

      <!-- Основная информация -->
      <div class="form-section">
        <h2 class="section-title">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 8px; vertical-align: middle;">
            <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
            <line x1="16" y1="2" x2="16" y2="6"></line>
            <line x1="8" y1="2" x2="8" y2="6"></line>
            <line x1="3" y1="10" x2="21" y2="10"></line>
          </svg>
          Основная информация
        </h2>
        <div class="form-grid">
          <div class="form-group">
            <label class="form-label">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#3498db" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 6px; vertical-align: middle;">
                <path d="M20.24 12.24a6 6 0 0 0-8.49-8.49L5 10.5V19h8.5z"></path>
                <line x1="16" y1="8" x2="2" y2="22"></line>
                <line x1="17.5" y1="15" x2="9" y2="15"></line>
              </svg>
              Название мероприятия
            </label>
            {{ form.name }}
            {% if form.name.errors %}
              <div class="error-message">{{ form.name.errors }}</div>
            {% endif %}
          </div>
        </div>
      </div>

      <!-- Даты и время (множественный выбор) -->
      <div class="form-section">
        <h2 class="section-title">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 8px; vertical-align: middle;">
            <circle cx="12" cy="12" r="10"></circle>
            <polyline points="12 6 12 12 16 14"></polyline>
          </svg>
          Даты и время
          <span class="dates-count-badge" id="datesCount">(1 дата)</span>
        </h2>

        <div class="dates-container" id="datesContainer">
          <!-- Блоки дат будут вставлены здесь через JavaScript -->
        </div>

        <div class="dates-actions">
          <button type="button" class="btn btn-secondary" onclick="addDateRange()">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 6px;">
              <line x1="12" y1="5" x2="12" y2="19"></line>
              <line x1="5" y1="12" x2="19" y2="12"></line>
            </svg>
            Добавить дату
          </button>

          <button type="button" class="btn btn-secondary" onclick="duplicateLastDate()">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 6px;">
              <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
              <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
            </svg>
            Дублировать последнюю
          </button>
        </div>

        <!-- Скрытые поля для хранения JSON с датами -->
        <input type="hidden" name="dates_json" id="datesJson" value="[]">
      </div>

      <!-- Категория и подразделение -->
      <div class="form-section">
        <h2 class="section-title">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 8px; vertical-align: middle;">
            <path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path>
            <line x1="7" y1="7" x2="7.01" y2="7"></line>
          </svg>
          Классификация
        </h2>
        <div class="form-grid">
          <div class="form-group">
            <label class="form-label">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#9b59b6" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 6px; vertical-align: middle;">
                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                <circle cx="9" cy="7" r="4"></circle>
                <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
              </svg>
              Категория
            </label>
            {{ form.category }}
            {% if form.category.errors %}
              <div class="error-message">{{ form.category.errors }}</div>
            {% endif %}
          </div>

          <div class="form-group">
            <label class="form-label">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#2ecc71" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 6px; vertical-align: middle;">
                <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                <circle cx="12" cy="10" r="3"></circle>
              </svg>
              Подразделение
            </label>
            {{ form.department }}
            {% if form.department.errors %}
              <div class="error-message">{{ form.department.errors }}</div>
            {% endif %}
          </div>
        </div>
      </div>

      <!-- Ответственные и место -->
      <div class="form-section">
        <h2 class="section-title">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 8px; vertical-align: middle;">
            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
            <circle cx="12" cy="7" r="4"></circle>
          </svg>
          Организация
        </h2>
        <div class="form-grid">
          <div class="form-group">
            <label class="form-label">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#f39c12" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 6px; vertical-align: middle;">
                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                <circle cx="9" cy="7" r="4"></circle>
                <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
              </svg>
              Ответственные
            </label>
            {{ form.responsible }}
            {% if form.responsible.errors %}
              <div class="error-message">{{ form.responsible.errors }}</div>
            {% endif %}
          </div>

          <div class="form-group">
            <label class="form-label">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#e74c3c" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 6px; vertical-align: middle;">
                <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                <circle cx="12" cy="10" r="3"></circle>
              </svg>
              Место проведения
            </label>
            {{ form.place }}
            {% if form.place.errors %}
              <div class="error-message">{{ form.place.errors }}</div>
            {% endif %}
          </div>
        </div>
      </div>

      <!-- Комментарий -->
      <div class="form-section">
        <h2 class="section-title">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 8px; vertical-align: middle;">
            <path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"></path>
          </svg>
          Дополнительная информация
        </h2>
        <div class="form-group full-width">
          <label class="form-label">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#3498db" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 6px; vertical-align: middle;">
              <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
            </svg>
            Комментарий
          </label>
          {{ form.comment }}
          {% if form.comment.errors %}
            <div class="error-message">{{ form.comment.errors }}</div>
          {% endif %}
        </div>
      </div>

      <!-- Кнопки действий -->
      <div class="form-actions">
        <button type="submit" class="btn btn-primary">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 8px; vertical-align: middle;">
            <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
            <polyline points="17 21 17 13 7 13 7 21"></polyline>
            <polyline points="7 3 7 8 15 8"></polyline>
          </svg>
          Сохранить изменения
        </button>
        <a href="{% url 'events_ui' %}" class="btn btn-secondary">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 8px; vertical-align: middle;">
            <line x1="19" y1="12" x2="5" y2="12"></line>
            <polyline points="12 19 5 12 12 5"></polyline>
          </svg>
          Отмена
        </a>
        <button type="button" class="btn btn-danger" onclick="confirmDelete()">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 8px; vertical-align: middle;">
            <polyline points="3 6 5 6 21 6"></polyline>
            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
            <line x1="10" y1="11" x2="10" y2="17"></line>
            <line x1="14" y1="11" x2="14" y2="17"></line>
          </svg>
          Удалить
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Календарь для выбора даты -->
<div id="calendarModal" class="calendar-modal">
  <div class="calendar-content">
    <div class="calendar-header">
      <h3>Выберите дату и время</h3>
      <button type="button" class="close-calendar" onclick="closeCalendar()">&times;</button>
    </div>
    <div class="calendar-body">
      <div class="calendar-date-selector">
        <div class="calendar-month-year">
          <button type="button" class="calendar-nav" onclick="changeMonth(-1)">‹</button>
          <span id="currentMonthYear">Декабрь 2024</span>
          <button type="button" class="calendar-nav" onclick="changeMonth(1)">›</button>
        </div>
        <div class="calendar-days">
          <!-- Дни недели -->
          <div class="day-header">Пн</div>
          <div class="day-header">Вт</div>
          <div class="day-header">Ср</div>
          <div class="day-header">Чт</div>
          <div class="day-header">Пт</div>
          <div class="day-header">Сб</div>
          <div class="day-header">Вс</div>
          <!-- Дни месяца будут вставлены через JavaScript -->
        </div>
        <div class="calendar-time">
          <div class="time-selector">
            <label>Время:</label>
            <div class="time-inputs">
              <input type="number" id="calendarHour" min="0" max="23" value="12" placeholder="ЧЧ">
              <span>:</span>
              <input type="number" id="calendarMinute" min="0" max="59" value="0" placeholder="ММ">
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="calendar-footer">
      <button type="button" class="btn btn-secondary" onclick="setCurrentTime()">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 6px; vertical-align: middle;">
          <circle cx="12" cy="12" r="10"></circle>
          <polyline points="12 6 12 12 16 14"></polyline>
        </svg>
        Сейчас
      </button>
      <button type="button" class="btn btn-secondary" onclick="setSelectedDateTime()">Выбрать</button>
    </div>
  </div>
</div>

<script>
// Переменные для календаря
let currentDate = new Date();
let currentField = null;
let calendarDaysContainer = null;
let selectedDay = null;

function showCalendar(fieldId) {
  currentField = document.getElementById(fieldId);

  if (currentField) {
    // Если в поле уже есть значение, используем его
    if (currentField.value) {
      const [datePart, timePart] = currentField.value.split('T');
      if (datePart) {
        const [year, month, day] = datePart.split('-');
        currentDate = new Date(year, month - 1, day);
      }
      if (timePart) {
        const [hours, minutes] = timePart.split(':');
        document.getElementById('calendarHour').value = parseInt(hours) || 12;
        document.getElementById('calendarMinute').value = parseInt(minutes) || 0;
      }
    } else {
      currentDate = new Date();
      document.getElementById('calendarHour').value = currentDate.getHours();
      document.getElementById('calendarMinute').value = currentDate.getMinutes();
    }
  }

  updateCalendar();
  document.getElementById('calendarModal').style.display = 'block';

  // Выделяем сегодняшнюю дату по умолчанию
  setTimeout(() => {
    const today = new Date();
    const todayString = today.toISOString().split('T')[0];
    const todayElement = document.querySelector(`.calendar-day[data-date="${todayString}"]`);
    if (todayElement && !selectedDay) {
      document.querySelectorAll('.calendar-day').forEach(day => {
        day.classList.remove('selected');
      });
      todayElement.classList.add('selected');
      selectedDay = todayElement;
    }
  }, 100);
}

function closeCalendar() {
  document.getElementById('calendarModal').style.display = 'none';
}

function updateCalendar() {
  const monthNames = [
    'Январь', 'Февраль', 'Март', 'Апрель', 'Май', 'Июнь',
    'Июль', 'Август', 'Сентябрь', 'Октябрь', 'Ноябрь', 'Декабрь'
  ];

  const year = currentDate.getFullYear();
  const month = currentDate.getMonth();

  document.getElementById('currentMonthYear').textContent =
    `${monthNames[month]} ${year}`;

  // Первый день месяца
  const firstDay = new Date(year, month, 1);
  // Последний день месяца
  const lastDay = new Date(year, month + 1, 0);
  // Первый день для отображения (может быть с прошлого месяца)
  const startDay = new Date(firstDay);
  startDay.setDate(startDay.getDate() - (firstDay.getDay() + 6) % 7);

  calendarDaysContainer = document.querySelector('.calendar-days');
  // Очищаем предыдущие дни (кроме заголовков)
  while (calendarDaysContainer.children.length > 7) {
    calendarDaysContainer.removeChild(calendarDaysContainer.lastChild);
  }

  // Заполняем дни
  const tempDate = new Date(startDay);
  for (let i = 0; i < 42; i++) { // 6 недель × 7 дней
    const dayElement = document.createElement('div');
    dayElement.className = 'calendar-day';

    // Проверяем, относится ли день к текущему месяцу
    if (tempDate.getMonth() !== month) {
      dayElement.classList.add('other-month');
    }

    // Проверяем, является ли день сегодняшним
    const today = new Date();
    if (tempDate.toDateString() === today.toDateString()) {
      dayElement.classList.add('today');
    }

    dayElement.textContent = tempDate.getDate();
    dayElement.dataset.date = tempDate.toISOString().split('T')[0];
    dayElement.dataset.fullDate = tempDate.toISOString();

    dayElement.addEventListener('click', () => {
      // Убираем выделение со всех дней
      document.querySelectorAll('.calendar-day').forEach(day => {
        day.classList.remove('selected');
      });
      // Выделяем выбранный день
      dayElement.classList.add('selected');
      selectedDay = dayElement;

      // Обновляем currentDate на выбранную дату
      const selectedDate = new Date(dayElement.dataset.fullDate);
      currentDate = new Date(selectedDate.getFullYear(), selectedDate.getMonth(), selectedDate.getDate());
    });

    calendarDaysContainer.appendChild(dayElement);
    tempDate.setDate(tempDate.getDate() + 1);
  }
}

function changeMonth(delta) {
  currentDate.setMonth(currentDate.getMonth() + delta);
  updateCalendar();
  selectedDay = null;
}

function setCurrentTime() {
  const now = new Date();
  document.getElementById('calendarHour').value = now.getHours();
  document.getElementById('calendarMinute').value = now.getMinutes();
  currentDate = new Date(now);
  updateCalendar();

  setTimeout(() => {
    const today = new Date();
    const todayString = today.toISOString().split('T')[0];
    const todayElement = document.querySelector(`.calendar-day[data-date="${todayString}"]`);
    if (todayElement) {
      document.querySelectorAll('.calendar-day').forEach(day => {
        day.classList.remove('selected');
      });
      todayElement.classList.add('selected');
      selectedDay = todayElement;
    }
  }, 100);
}

function setSelectedDateTime() {
  if (window.calendarForDate) {
    // Для динамических дат
    const { id, field } = window.calendarForDate;
    const hour = document.getElementById('calendarHour').value.padStart(2, '0');
    const minute = document.getElementById('calendarMinute').value.padStart(2, '0');
    const year = currentDate.getFullYear();
    const month = (currentDate.getMonth() + 1).toString().padStart(2, '0');
    const day = currentDate.getDate().toString().padStart(2, '0');

    const dateTime = `${year}-${month}-${day}T${hour}:${minute}`;
    updateDateRange(id, field, dateTime);

    const input = document.querySelector(`.date-range-item[data-id="${id}"] .date-${field}-input`);
    if (input) {
      input.value = dateTime;
    }

    window.calendarForDate = null;
    closeCalendar();
  } else if (currentField) {
    // Для обычных полей
    const hour = document.getElementById('calendarHour').value.padStart(2, '0');
    const minute = document.getElementById('calendarMinute').value.padStart(2, '0');
    const year = currentDate.getFullYear();
    const month = (currentDate.getMonth() + 1).toString().padStart(2, '0');
    const day = currentDate.getDate().toString().padStart(2, '0');

    currentField.value = `${year}-${month}-${day}T${hour}:${minute}`;
    closeCalendar();
  }
}

// Управление множественными датами
let dateRanges = [];

// Инициализация дат при загрузке страницы
document.addEventListener('DOMContentLoaded', function() {
  initializeDates();

  // Обновляем календарь
  updateCalendar();
});

function initializeDates() {
  const datesContainer = document.getElementById('datesContainer');
  const datesJsonInput = document.getElementById('datesJson');

  // Очищаем контейнер
  datesContainer.innerHTML = '';

  // Пытаемся извлечь даты из комментария (если они там сохранены)
  let extractedDates = extractDatesFromComment();

  if (extractedDates.length > 0) {
    // Используем даты из комментария
    dateRanges = extractedDates;
  } else {
    // Используем основные поля формы
    const startField = document.getElementById('id_date');
    const endField = document.getElementById('id_end_date');

    if (startField && endField && startField.value && endField.value) {
      dateRanges = [{
        start: startField.value,
        end: endField.value,
        id: generateId()
      }];
    } else {
      // Создаем первую дату по умолчанию
      const now = new Date();
      const startTime = new Date(now.getTime() + 60 * 60 * 1000);
      const endTime = new Date(startTime.getTime() + 2 * 60 * 60 * 1000);

      dateRanges = [{
        start: formatDateTime(startTime),
        end: formatDateTime(endTime),
        id: generateId()
      }];
    }
  }

  // Рендерим все даты
  renderAllDates();

  // Обновляем счетчик
  updateDatesCount();

  // Сохраняем в скрытое поле
  saveDatesToJson();
}

function extractDatesFromComment() {
  const commentField = document.getElementById('id_comment');
  if (!commentField || !commentField.value) return [];

  const comment = commentField.value;
  const dates = [];

  // Ищем даты в формате "ДАТЫ:" в комментарии
  const dateSectionIndex = comment.indexOf('ДАТЫ:');
  if (dateSectionIndex === -1) return [];

  // Получаем все строки после "ДАТЫ:"
  const dateLines = comment.substring(dateSectionIndex).split('\n');

  for (const line of dateLines) {
    const trimmed = line.trim();
    if (!trimmed || trimmed === 'ДАТЫ:') continue;

    // Пытаемся распарсить строку вида "2032-12-22T19:32 - 2032-12-22T21:32"
    // или "2032-12-22T19:32 — 2032-12-22T21:32"
    const match = trimmed.match(/(\d{4}-\d{2}-\d{2}T\d{2}:\d{2})\s*[—\-]\s*(\d{4}-\d{2}-\d{2}T\d{2}:\d{2})/);
    if (match) {
      dates.push({
        start: match[1],
        end: match[2],
        id: generateId()
      });
    }
  }

  return dates;
}

function addDateRange() {
  const lastRange = dateRanges[dateRanges.length - 1];
  let newStart, newEnd;

  if (lastRange) {
    const lastEnd = new Date(lastRange.end);
    newStart = new Date(lastEnd.getTime() + 24 * 60 * 60 * 1000);
    newEnd = new Date(newStart.getTime() + 2 * 60 * 60 * 1000);
  } else {
    const now = new Date();
    newStart = new Date(now.getTime() + 60 * 60 * 1000);
    newEnd = new Date(newStart.getTime() + 2 * 60 * 60 * 1000);
  }

  dateRanges.push({
    start: formatDateTime(newStart),
    end: formatDateTime(newEnd),
    id: generateId()
  });

  renderAllDates();
  updateDatesCount();
  saveDatesToJson();
}

function duplicateLastDate() {
  if (dateRanges.length === 0) {
    addDateRange();
    return;
  }

  const lastRange = dateRanges[dateRanges.length - 1];
  const newStart = new Date(lastRange.start);
  const newEnd = new Date(lastRange.end);

  newStart.setDate(newStart.getDate() + 1);
  newEnd.setDate(newEnd.getDate() + 1);

  dateRanges.push({
    start: formatDateTime(newStart),
    end: formatDateTime(newEnd),
    id: generateId()
  });

  renderAllDates();
  updateDatesCount();
  saveDatesToJson();
}

function removeDateRange(id) {
  if (dateRanges.length <= 1) {
    alert('Мероприятие должно иметь хотя бы одну дату');
    return;
  }

  dateRanges = dateRanges.filter(range => range.id !== id);
  renderAllDates();
  updateDatesCount();
  saveDatesToJson();
}

function renderAllDates() {
  const datesContainer = document.getElementById('datesContainer');
  datesContainer.innerHTML = '';

  dateRanges.forEach((range, index) => {
    const dateElement = createDateElement(range, index);
    datesContainer.appendChild(dateElement);
  });
}

function createDateElement(range, index) {
  const div = document.createElement('div');
  div.className = 'date-range-item';
  div.dataset.id = range.id;

  div.innerHTML = `
    <div class="date-range-header">
      <h4>Дата ${index + 1}</h4>
      ${index > 0 ? `
        <button type="button" class="remove-date-btn" onclick="removeDateRange('${range.id}')" title="Удалить дату">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#e74c3c" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      ` : ''}
    </div>
    <div class="date-range-grid">
      <div class="form-group">
        <label class="form-label">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#e74c3c" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 6px; vertical-align: middle;">
            <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
            <line x1="16" y1="2" x2="16" y2="6"></line>
            <line x1="8" y1="2" x2="8" y2="6"></line>
            <line x1="3" y1="10" x2="21" y2="10"></line>
          </svg>
          Дата и время начала
        </label>
        <div class="datetime-container">
          <input type="datetime-local"
                 class="date-start-input"
                 value="${range.start}"
                 onchange="updateDateRange('${range.id}', 'start', this.value)">
          <button type="button" class="datetime-btn" onclick="showCalendarForDate('${range.id}', 'start')">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
              <line x1="16" y1="2" x2="16" y2="6"></line>
              <line x1="8" y1="2" x2="8" y2="6"></line>
              <line x1="3" y1="10" x2="21" y2="10"></line>
            </svg>
          </button>
        </div>
      </div>

      <div class="form-group">
        <label class="form-label">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#e74c3c" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 6px; vertical-align: middle;">
            <circle cx="12" cy="12" r="10"></circle>
            <polyline points="12 6 12 12 16 14"></polyline>
          </svg>
          Дата и время окончания
        </label>
        <div class="datetime-container">
          <input type="datetime-local"
                 class="date-end-input"
                 value="${range.end}"
                 onchange="updateDateRange('${range.id}', 'end', this.value)">
          <button type="button" class="datetime-btn" onclick="showCalendarForDate('${range.id}', 'end')">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
              <line x1="16" y1="2" x2="16" y2="6"></line>
              <line x1="8" y1="2" x2="8" y2="6"></line>
              <line x1="3" y1="10" x2="21" y2="10"></line>
            </svg>
          </button>
        </div>
      </div>
    </div>
  `;

  return div;
}

function updateDateRange(id, field, value) {
  const range = dateRanges.find(r => r.id === id);
  if (range) {
    range[field] = value;
    saveDatesToJson();
  }
}

function showCalendarForDate(id, field) {
  const range = dateRanges.find(r => r.id === id);
  if (!range) return;

  // Сохраняем информацию о том, для какого поля открываем календарь
  window.calendarForDate = { id, field };

  // Устанавливаем текущее значение в календарь
  const value = range[field];
  currentField = null;

  if (value) {
    const [datePart, timePart] = value.split('T');
    if (datePart) {
      const [year, month, day] = datePart.split('-');
      currentDate = new Date(year, month - 1, day);
    }
    if (timePart) {
      const [hours, minutes] = timePart.split(':');
      document.getElementById('calendarHour').value = parseInt(hours) || 12;
      document.getElementById('calendarMinute').value = parseInt(minutes) || 0;
    }
  } else {
    currentDate = new Date();
    document.getElementById('calendarHour').value = currentDate.getHours();
    document.getElementById('calendarMinute').value = currentDate.getMinutes();
  }

  updateCalendar();
  document.getElementById('calendarModal').style.display = 'block';
}

function updateDatesCount() {
  const countElement = document.getElementById('datesCount');
  if (countElement) {
    const count = dateRanges.length;
    countElement.textContent = `(${count} ${getRussianPlural(count, ['дата', 'даты', 'дат'])})`;
  }
}

function saveDatesToJson() {
  const datesJsonInput = document.getElementById('datesJson');
  if (datesJsonInput) {
    datesJsonInput.value = JSON.stringify(dateRanges);
  }
}

// Вспомогательные функции
function generateId() {
  return 'date_' + Math.random().toString(36).substr(2, 9);
}

function formatDateTime(date) {
  const year = date.getFullYear();
  const month = (date.getMonth() + 1).toString().padStart(2, '0');
  const day = date.getDate().toString().padStart(2, '0');
  const hours = date.getHours().toString().padStart(2, '0');
  const minutes = date.getMinutes().toString().padStart(2, '0');

  return `${year}-${month}-${day}T${hours}:${minutes}`;
}

function formatDateForDisplay(dateTimeString) {
  // Конвертируем строку "2032-12-22T19:32" в формат "22.12.2032 19:32"
  const [datePart, timePart] = dateTimeString.split('T');
  if (!datePart || !timePart) return dateTimeString;

  const [year, month, day] = datePart.split('-');
  const [hours, minutes] = timePart.split(':');

  return `${day}.${month}.${year} ${hours}:${minutes}`;
}





function getRussianPlural(number, words) {
  const cases = [2, 0, 1, 1, 1, 2];
  return words[(number % 100 > 4 && number % 100 < 20) ? 2 : cases[(number % 10 < 5) ? number % 10 : 5]];
}

// Функция удаления
function confirmDelete() {
  if (confirm('Вы уверены, что хотите удалить это мероприятие? Это действие нельзя отменить.')) {
    window.location.href = "{% url 'delete_event' event.id %}";
  }
}

// Инициализация календаря
updateCalendar();
</script>

<style>
.event-form-container {
  max-width: 1200px;
  margin: 0 auto;
  padding: 20px;
}

.event-form-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 30px;
  padding-bottom: 20px;
  border-bottom: 2px solid #4a5f7a;
}

.page-title {
  color: #ecf0f1;
  font-size: 28px;
  font-weight: 700;
  margin: 0;
  display: flex;
  align-items: center;
}

.page-title svg {
  stroke: #1abc9c;
}

.event-id {
  display: flex;
  align-items: center;
  background: rgba(26, 188, 156, 0.1);
  padding: 8px 16px;
  border-radius: 20px;
  border: 1px solid rgba(26, 188, 156, 0.3);
}

.id-label {
  color: #95a5a6;
  font-size: 14px;
  font-weight: 600;
  margin-right: 8px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.id-value {
  color: #1abc9c;
  font-size: 16px;
  font-weight: 700;
  font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
}

.event-form-card {
  background: linear-gradient(145deg, #2c3e50, #34495e);
  border-radius: 16px;
  padding: 40px;
  box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
  border: 1px solid #4a5f7a;
  position: relative;
  overflow: hidden;
}

.event-form-card::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  width: 6px;
  height: 100%;
  background: linear-gradient(to bottom, #1abc9c, #3498db);
}

.event-form {
  display: flex;
  flex-direction: column;
  gap: 30px;
}

.form-section {
  background: rgba(255, 255, 255, 0.05);
  border-radius: 12px;
  padding: 25px;
  border: 1px solid rgba(255, 255, 255, 0.1);
  transition: all 0.3s ease;
}

.form-section:hover {
  background: rgba(255, 255, 255, 0.08);
  border-color: rgba(26, 188, 156, 0.3);
  transform: translateY(-2px);
}

.section-title {
  color: #ecf0f1;
  font-size: 20px;
  font-weight: 600;
  margin: 0 0 25px 0;
  display: flex;
  align-items: center;
  padding-bottom: 15px;
  border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

.section-title svg {
  stroke: #1abc9c;
}

.form-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
  gap: 25px;
}

.date-grid {
  grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
}

.form-group {
  display: flex;
  flex-direction: column;
}

.form-group.full-width {
  grid-column: 1 / -1;
}

.form-label {
  color: #ecf0f1;
  font-size: 14px;
  font-weight: 600;
  margin-bottom: 8px;
  display: flex;
  align-items: center;
}

.form-label svg {
  flex-shrink: 0;
}

/* Стили для контейнера даты-времени */
.datetime-container {
  position: relative;
  display: flex;
}

.datetime-container input[type="datetime-local"] {
  flex: 1;
  padding-right: 50px;
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}

.datetime-btn {
  position: absolute;
  right: 4px;
  top: 50%;
  transform: translateY(-50%);
  background: rgba(26, 188, 156, 0.1);
  border: 2px solid #4a5f7a;
  border-radius: 8px;
  color: #ecf0f1;
  padding: 8px 12px;
  cursor: pointer;
  transition: all 0.3s ease;
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 2;
}

.datetime-btn:hover {
  background: rgba(26, 188, 156, 0.2);
  border-color: #1abc9c;
  transform: translateY(-50%) scale(1.05);
}

.datetime-btn svg {
  stroke: #1abc9c;
}

/* Стили для полей формы */
.event-form input[type="text"],
.event-form input[type="email"],
.event-form input[type="password"],
.event-form input[type="date"],
.event-form input[type="datetime-local"],
.event-form textarea,
.event-form select {
  width: 100%;
  padding: 14px 16px;
  background: #1a2530;
  border: 2px solid #4a5f7a;
  border-radius: 10px;
  color: #ecf0f1;
  font-size: 16px;
  font-family: inherit;
  transition: all 0.3s ease;
  outline: none;
}

.event-form input[type="text"]:focus,
.event-form input[type="email"]:focus,
.event-form input[type="password"]:focus,
.event-form input[type="date"]:focus,
.event-form input[type="datetime-local"]:focus,
.event-form textarea:focus,
.event-form select:focus {
  border-color: #1abc9c;
  box-shadow: 0 0 0 3px rgba(26, 188, 156, 0.2);
  background: #1f2b38;
}

.event-form textarea {
  min-height: 120px;
  resize: vertical;
  line-height: 1.5;
}

.event-form select {
  appearance: none;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%2395a5a6' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: right 16px center;
  background-size: 16px;
  padding-right: 45px;
}

.error-message {
  color: #e74c3c;
  font-size: 14px;
  margin-top: 6px;
  padding: 8px 12px;
  background: rgba(231, 76, 60, 0.1);
  border-radius: 6px;
  border-left: 3px solid #e74c3c;
}

.error-message ul {
  margin: 0;
  padding-left: 20px;
}

.error-message li {
  margin: 4px 0;
}

.form-actions {
  display: flex;
  gap: 15px;
  justify-content: flex-end;
  padding-top: 30px;
  border-top: 1px solid rgba(255, 255, 255, 0.1);
  margin-top: 10px;
}

.btn {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  padding: 14px 28px;
  border: none;
  border-radius: 10px;
  font-size: 16px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
  text-decoration: none;
  font-family: inherit;
  min-width: 160px;
}

.btn-primary {
  background: linear-gradient(135deg, #1abc9c 0%, #16a085 100%);
  color: white;
}

.btn-primary:hover {
  transform: translateY(-3px);
  box-shadow: 0 10px 20px rgba(26, 188, 156, 0.4);
}

.btn-secondary {
  background: linear-gradient(135deg, #95a5a6 0%, #7f8c8d 100%);
  color: white;
}

.btn-secondary:hover {
  transform: translateY(-3px);
  box-shadow: 0 10px 20px rgba(149, 165, 166, 0.4);
}

.btn-danger {
  background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
  color: white;
}

.btn-danger:hover {
  transform: translateY(-3px);
  box-shadow: 0 10px 20px rgba(231, 76, 60, 0.4);
}

/* Стили для календаря */
.calendar-modal {
  display: none;
  position: fixed;
  z-index: 1000;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 0.7);
  animation: fadeIn 0.3s ease-out;
}

.calendar-content {
  background: linear-gradient(145deg, #2c3e50, #34495e);
  margin: 10% auto;
  padding: 0;
  border-radius: 16px;
  width: 90%;
  max-width: 500px;
  box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);
  border: 1px solid #4a5f7a;
  overflow: hidden;
}

.calendar-header {
  background: linear-gradient(135deg, #1abc9c 0%, #16a085 100%);
  padding: 20px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.calendar-header h3 {
  margin: 0;
  color: white;
  font-weight: 600;
}

.close-calendar {
  background: none;
  border: none;
  color: white;
  font-size: 28px;
  cursor: pointer;
  padding: 0;
  width: 30px;
  height: 30px;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: transform 0.3s ease;
}

.close-calendar:hover {
  transform: scale(1.2);
}

.calendar-body {
  padding: 20px;
}

.calendar-month-year {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 20px;
  background: rgba(255, 255, 255, 0.05);
  padding: 10px;
  border-radius: 10px;
}

.calendar-month-year span {
  color: #ecf0f1;
  font-size: 18px;
  font-weight: 600;
}

.calendar-nav {
  background: rgba(26, 188, 156, 0.1);
  border: 2px solid #4a5f7a;
  border-radius: 8px;
  color: #ecf0f1;
  width: 40px;
  height: 40px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: all 0.3s ease;
  font-size: 20px;
}

.calendar-nav:hover {
  background: rgba(26, 188, 156, 0.2);
  border-color: #1abc9c;
  transform: scale(1.1);
}

.calendar-days {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  gap: 8px;
  margin-bottom: 20px;
}

.day-header {
  color: #95a5a6;
  font-weight: 600;
  font-size: 14px;
  text-align: center;
  padding: 10px 0;
  text-transform: uppercase;
}

.calendar-day {
  color: #ecf0f1;
  text-align: center;
  padding: 12px 0;
  border-radius: 8px;
  cursor: pointer;
  transition: all 0.3s ease;
  font-weight: 500;
  border: 2px solid transparent;
}

.calendar-day:hover {
  background: rgba(26, 188, 156, 0.1);
  border-color: #4a5f7a;
  transform: scale(1.05);
}

.calendar-day.selected {
  background: linear-gradient(135deg, #1abc9c 0%, #16a085 100%);
  color: white;
  border-color: #1abc9c;
  font-weight: 600;
}

.calendar-day.today {
  border: 2px solid #3498db;
}

.calendar-day.other-month {
  color: #7f8c8d;
  opacity: 0.5;
}

.calendar-time {
  background: rgba(255, 255, 255, 0.05);
  padding: 20px;
  border-radius: 10px;
  margin-top: 20px;
}

.time-selector {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 15px;
}

.time-selector label {
  color: #ecf0f1;
  font-weight: 600;
  font-size: 16px;
}

.time-inputs {
  display: flex;
  align-items: center;
  gap: 10px;
}

.time-inputs input {
  width: 60px;
  padding: 10px;
  background: #1a2530;
  border: 2px solid #4a5f7a;
  border-radius: 8px;
  color: #ecf0f1;
  font-size: 16px;
  text-align: center;
  transition: all 0.3s ease;
}

.time-inputs input:focus {
  border-color: #1abc9c;
  box-shadow: 0 0 0 3px rgba(26, 188, 156, 0.2);
}

.time-inputs span {
  color: #ecf0f1;
  font-size: 18px;
  font-weight: bold;
}

.calendar-footer {
  padding: 20px;
  display: flex;
  justify-content: space-between;
  border-top: 1px solid #4a5f7a;
  background: rgba(255, 255, 255, 0.05);
}

/* Анимации */
@keyframes fadeIn {
  from {
    opacity: 0;
    transform: translateY(-20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.event-form-card {
  animation: fadeIn 0.5s ease-out;
}

/* Стили для множественных дат */
.dates-count-badge {
  background: rgba(26, 188, 156, 0.2);
  color: #1abc9c;
  font-size: 14px;
  font-weight: 600;
  padding: 4px 10px;
  border-radius: 12px;
  margin-left: 10px;
  border: 1px solid rgba(26, 188, 156, 0.3);
}

.dates-container {
  display: flex;
  flex-direction: column;
  gap: 20px;
  margin-bottom: 20px;
}

.date-range-item {
  background: rgba(255, 255, 255, 0.03);
  border-radius: 10px;
  padding: 20px;
  border: 1px solid rgba(255, 255, 255, 0.1);
  transition: all 0.3s ease;
  position: relative;
}

.date-range-item:hover {
  background: rgba(255, 255, 255, 0.05);
  border-color: rgba(26, 188, 156, 0.2);
}

.date-range-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 15px;
  padding-bottom: 10px;
  border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

.date-range-header h4 {
  margin: 0;
  color: #ecf0f1;
  font-size: 16px;
  font-weight: 600;
}

.remove-date-btn {
  background: rgba(231, 76, 60, 0.1);
  border: 1px solid rgba(231, 76, 60, 0.3);
  border-radius: 6px;
  color: #e74c3c;
  padding: 6px 10px;
  cursor: pointer;
  transition: all 0.3s ease;
  display: flex;
  align-items: center;
  justify-content: center;
}

.remove-date-btn:hover {
  background: rgba(231, 76, 60, 0.2);
  border-color: #e74c3c;
  transform: scale(1.05);
}

.date-range-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
  gap: 20px;
}

.dates-actions {
  display: flex;
  gap: 10px;
  margin-top: 20px;
}

.dates-actions .btn {
  min-width: auto;
  padding: 10px 16px;
}

.dates-actions .btn svg {
  margin-right: 6px;
}

/* Стили для динамических полей ввода даты */
.date-start-input,
.date-end-input {
  width: 100%;
  padding: 14px 16px;
  background: #1a2530;
  border: 2px solid #4a5f7a;
  border-radius: 10px;
  color: #ecf0f1;
  font-size: 16px;
  font-family: inherit;
  transition: all 0.3s ease;
  outline: none;
  padding-right: 50px;
}

.date-start-input:focus,
.date-end-input:focus {
  border-color: #1abc9c;
  box-shadow: 0 0 0 3px rgba(26, 188, 156, 0.2);
  background: #1f2b38;
}

/* Скрываем оригинальные поля дат */
#id_date,
#id_end_date {
  display: none !important;
}

/* Адаптивность */
@media (max-width: 768px) {
  .event-form-container {
    padding: 10px;
  }

  .event-form-header {
    flex-direction: column;
    align-items: flex-start;
    gap: 15px;
  }

  .page-title {
    font-size: 24px;
  }

  .event-form-card {
    padding: 20px;
  }

  .form-grid {
    grid-template-columns: 1fr;
  }

  .form-section {
    padding: 20px;
  }

  .form-actions {
    flex-direction: column;
    gap: 10px;
  }

  .btn {
    width: 100%;
    min-width: auto;
  }

  .calendar-content {
    margin: 5% auto;
    width: 95%;
  }

  .calendar-day {
    padding: 8px 0;
  }
}

@media (max-width: 480px) {
  .form-section {
    padding: 15px;
  }

  .section-title {
    font-size: 18px;
  }

  .event-form input[type="text"],
  .event-form input[type="email"],
  .event-form input[type="password"],
  .event-form input[type="date"],
  .event-form input[type="datetime-local"],
  .event-form textarea,
  .event-form select {
    padding: 12px 14px;
    font-size: 15px;
  }

  .calendar-day {
    padding: 6px 0;
    font-size: 14px;
  }

  .time-inputs input {
    width: 50px;
    padding: 8px;
  }
}
</style>
{% endblock %}