{% extends 'base.html' %}

{% block content %}
  <h1>Список мероприятий</h1>

{% if user.is_authenticated %}
    <p>Привет, {{ user.username }}!</p>
    <form method="POST" action="{% url 'logout' %}">
        {% csrf_token %}
        <button type="submit">Выйти</button>
    </form>
    <form method="POST" action="{% url 'create_event' %}">
      {% csrf_token %}
      {{ form.as_p }}
      <button type="submit">Добавить мероприятие</button>
    </form>
  {% else %}
    <p>Для создания мероприятия нужно войти в систему.</p>
    <a href="{% url 'login' %}">Войти</a>
{% endif %}

<form method="GET" action="{% url 'events_ui' %}">
  <label for="month">Выберите месяц:</label>
  <select name="month" id="month">
    <option value="" {% if not month %}selected{% endif %}>Все</option>
    <option value="1" {% if month == '1' %}selected{% endif %}>Январь</option>
    <option value="2" {% if month == '2' %}selected{% endif %}>Февраль</option>
    <option value="3" {% if month == '3' %}selected{% endif %}>Март</option>
    <option value="4" {% if month == '4' %}selected{% endif %}>Апрель</option>
    <option value="5" {% if month == '5' %}selected{% endif %}>Май</option>
    <option value="6" {% if month == '6' %}selected{% endif %}>Июнь</option>
    <option value="7" {% if month == '7' %}selected{% endif %}>Июль</option>
    <option value="8" {% if month == '8' %}selected{% endif %}>Август</option>
    <option value="9" {% if month == '9' %}selected{% endif %}>Сентябрь</option>
    <option value="10" {% if month == '10' %}selected{% endif %}>Октябрь</option>
    <option value="11" {% if month == '11' %}selected{% endif %}>Ноябрь</option>
    <option value="12" {% if month == '12' %}selected{% endif %}>Декабрь</option>
  </select>

  <label for="year">Выберите год:</label>
  <input type="text" name="year" id="year" value="{{ year }}">

  <label for="sort_order">Сортировка:</label>
  <select name="sort_order" id="sort_order">
    <option value="asc" {% if sort_order == 'asc' %}selected{% endif %}>По возрастанию</option>
    <option value="desc" {% if sort_order == 'desc' %}selected{% endif %}>По убыванию</option>
  </select>

  <button type="submit">Фильтровать</button>
</form>

<form method="POST" action="{% url 'export_selected_events' %}">
  {% csrf_token %}
  <button type="submit">
      Экспортировать выбранные мероприятия в Excel
    </button>
  <div class="events-list">
    {% for event in page_obj %}
      <div class="event-card">
        <div class="event-header">
          <h3>{{ event.name }}</h3>
          <p class="event-date">{{ event.date|date:"d.m.Y H:i" }} — {{ event.end_date|date:"d.m.Y H:i" }}</p>
        </div>

        <div class="event-details">
          <div class="event-item">
            <strong>Категория:</strong> {{ event.category.name|default:"—" }}
          </div>
          <div class="event-item">
            <strong>Подразделение:</strong> {{ event.department.name|default:"—" }}
          </div>
          <div class="event-item">
            <strong>Ответственные:</strong>
            {% if event.responsible_list %}
              {{ event.responsible_list|join:", " }}
            {% else %}
              Нет ответственных
            {% endif %}
          </div>
          <div class="event-item">
            <strong>Место:</strong> {{ event.place|default:"—" }}
          </div>
          <div class="event-item">
            <strong>Комментарий:</strong> {{ event.comment|default:"Нет комментария" }}
          </div>
        </div>

        <div class="event-select">
          <input type="checkbox" name="selected_events" value="{{ event.id }}">
        </div>
      </div>
    {% empty %}
      <p>Нет мероприятий</p>
    {% endfor %}
  </div>
</form>




<div class="pagination">
  <span class="step-links">
    {% if page_obj.has_previous %}
      <a href="?page=1{% if month %}&month={{ month }}{% endif %}{% if year %}&year={{ year }}{% endif %}{% if sort_order %}&sort_order={{ sort_order }}{% endif %}">&laquo; первая</a>
      <a href="?page={{ page_obj.previous_page_number }}{% if month %}&month={{ month }}{% endif %}{% if year %}&year={{ year }}{% endif %}{% if sort_order %}&sort_order={{ sort_order }}{% endif %}">предыдущая</a>
    {% endif %}

    <span class="current">
      Страница {{ page_obj.number }} из {{ page_obj.paginator.num_pages }}.
    </span>

    {% if page_obj.has_next %}
      <a href="?page={{ page_obj.next_page_number }}{% if month %}&month={{ month }}{% endif %}{% if year %}&year={{ year }}{% endif %}{% if sort_order %}&sort_order={{ sort_order }}{% endif %}">следующая</a>
      <a href="?page={{ page_obj.paginator.num_pages }}{% if month %}&month={{ month }}{% endif %}{% if year %}&year={{ year }}{% endif %}{% if sort_order %}&sort_order={{ sort_order }}{% endif %}">последняя &raquo;</a>
    {% endif %}
  </span>
</div>

<style>
    .events-list {
      display: flex;
      flex-direction: column;
      gap: 20px;
      margin-top: 20px;
    }

    .event-card {
      background-color: #34495e;
      color: white;
      border-radius: 8px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      padding: 20px;
      width: 100%;
      box-sizing: border-box;
      border: 2px solid #f1f1f1;
      transition: all 0.3s ease;
    }

    .event-card:hover {
      border-color: #007bff;
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
    }

    .event-header {
      border-bottom: 1px solid #eee;
      margin-bottom: 10px;
      padding-bottom: 10px;
    }

    .event-header h3 {
      margin: 0;
      font-size: 18px;
      color: #fff;
    }

    .event-date {
      font-size: 14px;
      color: #ccc;
    }

    .event-details {
      margin-top: 10px;
    }

    .event-item {
      margin-bottom: 8px;
    }

    .event-item strong {
      font-weight: bold;
    }

    .event-item p {
      margin: 5px 0;
      color: #ddd;
    }

    .pagination {
      text-align: center;
      margin-top: 30px;
    }

    .step-links a {
      text-decoration: none;
      color: #007bff;
      margin: 0 10px;
    }

    .step-links a:hover {
      text-decoration: underline;
    }

    .current {
      font-weight: bold;
      color: #333;
    }

    button[type="submit"] {
      padding: 8px 16px;
      background-color: #28a745;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      margin-top: 20px;
    }

  </style>
{% endblock %}