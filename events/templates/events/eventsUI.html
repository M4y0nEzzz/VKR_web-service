{% extends 'base.html' %}
{% load custom_filters %}

{% block content %}
  <h1>Список мероприятий</h1>

  <!-- Кнопка для создания нового мероприятия -->
  <div class="create-event-section">
    <a href="{% url 'create_event' %}" class="create-event-btn">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 8px; vertical-align: middle;">
        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
        <polyline points="14 2 14 8 20 8"></polyline>
        <line x1="12" y1="18" x2="12" y2="12"></line>
        <line x1="9" y1="15" x2="15" y2="15"></line>
      </svg>
      Создать мероприятие
    </a>
  </div>

  <div class="statistics-section">
    <div class="statistics-cards">
        <div class="stat-card">
            <div class="stat-icon" style="background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                    <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path>
                </svg>
            </div>
            <div class="stat-content">
                <h3 class="stat-number">{{ total_events }}</h3>
                <p class="stat-label">Всего мероприятий</p>
            </div>
        </div>

        <div class="stat-card">
            <div class="stat-icon" style="background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                    <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                    <circle cx="12" cy="12" r="3"></circle>
                </svg>
            </div>
            <div class="stat-content">
                <h3 class="stat-number">{{ filtered_count }}</h3>
                <p class="stat-label">Найдено</p>
            </div>
        </div>
    </div>
</div>

  <!-- Форма фильтрации -->
  <form method="GET" action="{% url 'events_ui' %}" id="filterForm" class="advanced-filters">
    <div class="filters-grid">
        <!-- Поиск -->
        <div class="filter-group search-group">
            <label for="search">Поиск:</label>
            <div class="search-container">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#95a5a6" stroke-width="2">
                    <circle cx="11" cy="11" r="8"></circle>
                    <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                </svg>
                <input type="text"
                       name="search"
                       id="search"
                       value="{{ search_query|default:'' }}"
                       placeholder="Название, место, комментарий, ответственные..."
                       class="search-input">
            </div>
        </div>

        <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Сбрасываем выбор при изменении фильтров
            const filterInputs = document.querySelectorAll('#filterForm input, #filterForm select');
            filterInputs.forEach(input => {
                input.addEventListener('change', function() {
                    // Можно добавить подтверждение, если есть выбранные мероприятия
                    const checkboxes = document.querySelectorAll('.event-checkbox:checked');
                    if (checkboxes.length > 0) {
                        const confirmReset = confirm('Изменение фильтров сбросит выбранные мероприятия. Продолжить?');
                        if (!confirmReset) {
                            return;
                        }
                    }

                    // Сбрасываем выбор
                    resetSelection();
                });
            });
        });
        </script>


        <!-- Основные фильтры -->
        <div class="filter-row">
            <div class="filter-group">
                <label for="category">Категория:</label>
                <select name="category" id="category" class="filter-select">
                    <option value="">Все категории</option>
                    {% for category in categories %}
                    <option value="{{ category.id }}"
                            {% if selected_category == category.id|stringformat:"i" %}selected{% endif %}>
                        {{ category.name }}
                    </option>
                    {% endfor %}
                </select>
            </div>

            <div class="filter-group">
                <label for="department">Подразделение:</label>
                <select name="department" id="department" class="filter-select">
                    <option value="">Все подразделения</option>
                    {% for department in departments %}
                    <option value="{{ department.id }}"
                            {% if selected_department == department.id|stringformat:"i" %}selected{% endif %}>
                        {{ department.name }}
                    </option>
                    {% endfor %}
                </select>
            </div>
        </div>


        <!-- Диапазон дат (основной фильтр) -->
        <div class="filter-row">
            <div class="filter-group">
                <label for="start_date">От даты:</label>
                <div class="datetime-container">
                    <input type="date"
                           name="start_date"
                           id="start_date"
                           value="{{ start_date|default:'' }}"
                           class="filter-input">
                    <button type="button" class="datetime-btn" onclick="showCalendar('start_date')">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                            <line x1="16" y1="2" x2="16" y2="6"></line>
                            <line x1="8" y1="2" x2="8" y2="6"></line>
                            <line x1="3" y1="10" x2="21" y2="10"></line>
                        </svg>
                    </button>
                </div>
            </div>

            <div class="filter-group">
                <label for="end_date">До даты:</label>
                <div class="datetime-container">
                    <input type="date"
                           name="end_date"
                           id="end_date"
                           value="{{ end_date|default:'' }}"
                           class="filter-input">
                    <button type="button" class="datetime-btn" onclick="showCalendar('end_date')">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                            <line x1="16" y1="2" x2="16" y2="6"></line>
                            <line x1="8" y1="2" x2="8" y2="6"></line>
                            <line x1="3" y1="10" x2="21" y2="10"></line>
                        </svg>
                    </button>
                </div>
            </div>
        </div>

    <div class="filter-actions">
        <button type="submit" class="filter-btn">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 8px;">
                <polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon>
            </svg>
            Применить фильтры
        </button>

        {% if month or year or search_query or selected_category or selected_department or start_date or end_date %}
        <a href="{% url 'events_ui' %}" class="clear-filters">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 8px;">
                <line x1="18" y1="6" x2="6" y2="18"></line>
                <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
            Сбросить все фильтры
        </a>
        {% endif %}
    </div>
    </div>
  </form>

  <!-- Массовые действия -->
  <div class="bulk-actions">
    <button type="button" class="export-btn" id="exportBtn">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 8px;">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
            <polyline points="7 10 12 15 17 10"></polyline>
            <line x1="12" y1="15" x2="12" y2="3"></line>
        </svg>
        Экспортировать выбранные
    </button>

    <button type="button" class="delete-btn" id="deleteBtn">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 8px;">
            <polyline points="3 6 5 6 21 6"></polyline>
            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
            <line x1="10" y1="11" x2="10" y2="17"></line>
            <line x1="14" y1="11" x2="14" y2="17"></line>
        </svg>
        Удалить выбранные
    </button>

    <div class="selection-controls">
        <button type="button" class="select-all-btn" id="selectAllBtn">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 6px;">
                <polyline points="9 11 12 14 22 4"></polyline>
                <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path>
            </svg>
            <span id="selectAllText">Выбрать все</span>
        </button>

        <span class="selected-count" id="selectedCount">Выбрано: 0</span>
    </div>
  </div>

  <div class="events-list">
    {% for event in page_obj %}
    <div class="event-card">
        <div class="event-header">
            <div class="event-title-section">
                <h3 class="event-title">{{ event.name }}</h3>
                <p class="event-date">
                    {{ event.get_first_formatted_date|default:"" }}

                    {% if event.dates_count > 1 %}
                        <br>
                        <small style="color: #95a5a6;">+ еще {{ event.dates_count|add:"-1" }} {{ event.dates_count|add:"-1"|pluralize_ru:"дата, даты, дат" }}</small>
                    {% endif %}
                </p>
            </div>
            <div class="event-actions">
                <a href="{% url 'edit_event' event.id %}" class="edit-icon" title="Редактировать мероприятие">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#1abc9c" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                    </svg>
                </a>
            </div>
        </div>

        <div class="event-details-grid">
            <div class="detail-item">
                <div class="detail-icon">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#3498db" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path>
                        <line x1="7" y1="7" x2="7.01" y2="7"></line>
                    </svg>
                </div>
                <div class="detail-content">
                    <span class="detail-label">Категория:</span>
                    <span class="detail-value">{{ event.category.name|default:"—" }}</span>
                </div>
            </div>

            <div class="detail-item">
                <div class="detail-icon">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#e74c3c" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                        <circle cx="12" cy="10" r="3"></circle>
                    </svg>
                </div>
                <div class="detail-content">
                    <span class="detail-label">Подразделение:</span>
                    <span class="detail-value">{{ event.department.name|default:"—" }}</span>
                </div>
            </div>

            <div class="detail-item">
                <div class="detail-icon">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#2ecc71" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                        <circle cx="9" cy="7" r="4"></circle>
                        <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                        <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                    </svg>
                </div>
                <div class="detail-content">
                    <span class="detail-label">Ответственные:</span>
                    <span class="detail-value">
                        {% if event.responsible_list %}
                        {{ event.responsible_list|join:", " }}
                        {% else %}
                        Нет ответственных
                        {% endif %}
                    </span>
                </div>
            </div>

            <div class="detail-item">
                <div class="detail-icon">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#f39c12" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                        <circle cx="12" cy="10" r="3"></circle>
                    </svg>
                </div>
                <div class="detail-content">
                    <span class="detail-label">Место:</span>
                    <span class="detail-value">{{ event.place|default:"—" }}</span>
                </div>
            </div>

            <div class="detail-item full-width">
                <div class="detail-icon">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#9b59b6" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"></path>
                    </svg>
                </div>
                <div class="detail-content">
                    <span class="detail-label">Комментарий:</span>
                    <span class="detail-value">{{ event.comment|default:"Нет комментария" }}</span>
                </div>
            </div>
        </div>

        <div class="event-footer">
            <div class="checkbox-container">
                <input type="checkbox" name="selected_events" value="{{ event.id }}" id="event-{{ event.id }}" class="event-checkbox" data-event-name="{{ event.name }}">
                <label for="event-{{ event.id }}" class="checkbox-label">
                    <span class="checkmark"></span>
                    <span class="label-text">Выбрать мероприятие</span>
                </label>
            </div>
        </div>
    </div>
    {% empty %}
    <div class="empty-state">
        <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="#95a5a6" stroke-width="1" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="10"></circle>
            <line x1="12" y1="8" x2="12" y2="12"></line>
            <line x1="12" y1="16" x2="12.01" y2="16"></line>
        </svg>
        <p>Нет мероприятий для отображения</p>
    </div>
    {% endfor %}
  </div>

  <!-- Модальное окно подтверждения удаления -->
  <div id="deleteModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Подтверждение удаления</h3>
        <button type="button" class="close-modal" onclick="closeDeleteModal()">&times;</button>
      </div>
      <div class="modal-body">
        <p id="deleteMessage">Вы уверены, что хотите удалить выбранные мероприятия?</p>
        <div id="eventsToDelete" class="events-list-delete" style="display: none;">
          <h4>Будут удалены следующие мероприятия:</h4>
          <ul id="deleteEventsList"></ul>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" onclick="closeDeleteModal()">Отмена</button>
        <button type="button" class="btn btn-danger" onclick="deleteSelectedEvents()">Удалить</button>
      </div>
    </div>
  </div>

  <div class="pagination">
    <span class="step-links">
        {% if page_obj.has_previous %}
            <a href="?page=1{% if month %}&month={{ month }}{% endif %}{% if year %}&year={{ year }}{% endif %}{% if search_query %}&search={{ search_query }}{% endif %}{% if selected_category %}&category={{ selected_category }}{% endif %}{% if selected_department %}&department={{ selected_department }}{% endif %}{% if start_date %}&start_date={{ start_date }}{% endif %}{% if end_date %}&end_date={{ end_date }}{% endif %}{% if sort_order %}&sort_order={{ sort_order }}{% endif %}">&laquo; первая</a>
            <a href="?page={{ page_obj.previous_page_number }}{% if month %}&month={{ month }}{% endif %}{% if year %}&year={{ year }}{% endif %}{% if search_query %}&search={{ search_query }}{% endif %}{% if selected_category %}&category={{ selected_category }}{% endif %}{% if selected_department %}&department={{ selected_department }}{% endif %}{% if start_date %}&start_date={{ start_date }}{% endif %}{% if end_date %}&end_date={{ end_date }}{% endif %}{% if sort_order %}&sort_order={{ sort_order }}{% endif %}">предыдущая</a>
        {% endif %}

        <span class="current">
            Страница {{ page_obj.number }} из {{ page_obj.paginator.num_pages }}.
        </span>

        {% if page_obj.has_next %}
            <a href="?page={{ page_obj.next_page_number }}{% if month %}&month={{ month }}{% endif %}{% if year %}&year={{ year }}{% endif %}{% if search_query %}&search={{ search_query }}{% endif %}{% if selected_category %}&category={{ selected_category }}{% endif %}{% if selected_department %}&department={{ selected_department }}{% endif %}{% if start_date %}&start_date={{ start_date }}{% endif %}{% if end_date %}&end_date={{ end_date }}{% endif %}{% if sort_order %}&sort_order={{ sort_order }}{% endif %}">следующая</a>
            <a href="?page={{ page_obj.paginator.num_pages }}{% if month %}&month={{ month }}{% endif %}{% if year %}&year={{ year }}{% endif %}{% if search_query %}&search={{ search_query }}{% endif %}{% if selected_category %}&category={{ selected_category }}{% endif %}{% if selected_department %}&department={{ selected_department }}{% endif %}{% if start_date %}&start_date={{ start_date }}{% endif %}{% if end_date %}&end_date={{ end_date }}{% endif %}{% if sort_order %}&sort_order={{ sort_order }}{% endif %}">последняя &raquo;</a>
        {% endif %}
    </span>
  </div>
  <!-- Календарь для выбора даты в фильтрах -->
<div id="calendarModal" class="calendar-modal">
  <div class="calendar-content">
    <div class="calendar-header">
      <h3>Выберите дату</h3>
      <button type="button" class="close-calendar" onclick="closeCalendar()">&times;</button>
    </div>
    <div class="calendar-body">
      <div class="calendar-date-selector">
        <div class="calendar-month-year">
          <button type="button" class="calendar-nav" onclick="changeMonth(-1)">‹</button>
          <span id="currentMonthYear">Декабрь 2024</span>
          <button type="button" class="calendar-nav" onclick="changeMonth(1)">›</button>
        </div>
        <div class="calendar-days">
          <!-- Дни недели -->
          <div class="day-header">Пн</div>
          <div class="day-header">Вт</div>
          <div class="day-header">Ср</div>
          <div class="day-header">Чт</div>
          <div class="day-header">Пт</div>
          <div class="day-header">Сб</div>
          <div class="day-header">Вс</div>
          <!-- Дни месяца будут вставлены через JavaScript -->
        </div>
      </div>
    </div>
    <div class="calendar-footer">
      <button type="button" class="btn btn-secondary" onclick="setToday()">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 6px; vertical-align: middle;">
          <circle cx="12" cy="12" r="10"></circle>
          <polyline points="12 6 12 12 16 14"></polyline>
        </svg>
        Сегодня
      </button>
      <button type="button" class="btn btn-secondary" onclick="setSelectedDate()">Выбрать</button>
    </div>
  </div>
</div>



<script>
// Переменные для управления выбором
let isSelectAll = false;
let allFilteredEventIds = []; // Храним все ID отфильтрованных мероприятий

// Функция для получения всех ID отфильтрованных мероприятий
async function getAllFilteredEventIds() {
    try {
        // Получаем текущие параметры фильтрации из URL
        const urlParams = new URLSearchParams(window.location.search);

        // Создаем URL для получения всех отфильтрованных ID
        const getFilteredIdsUrl = `{% url 'get_filtered_event_ids' %}?${urlParams.toString()}`;

        // Запрашиваем все ID отфильтрованных мероприятий
        const response = await fetch(getFilteredIdsUrl);

        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        const data = await response.json();
        return data.event_ids || [];
    } catch (error) {
        console.error('Ошибка при получении отфильтрованных ID:', error);
        return [];
    }
}

// Переключение выбора всех мероприятий
async function toggleSelectAll() {
    const selectAllBtn = document.getElementById('selectAllBtn');
    const originalText = selectAllBtn.innerHTML;

    try {
        selectAllBtn.innerHTML = '<svg class="spinner" width="16" height="16" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none" opacity="0.25"/><path d="M12 2a10 10 0 0 1 10 10" stroke="currentColor" stroke-width="4" fill="none" stroke-linecap="round"/></svg> Загрузка...';
        selectAllBtn.disabled = true;

        // Проверяем текущее состояние
        const checkboxes = document.querySelectorAll('.event-checkbox');
        const checkedCheckboxes = document.querySelectorAll('.event-checkbox:checked');
        const allFilteredSelectedStr = localStorage.getItem('all_filtered_selected');

        // Если выбраны "все отфильтрованные" ИЛИ все на текущей странице
        const isCurrentlyAllSelected = (allFilteredSelectedStr && checkedCheckboxes.length > 0) ||
                                       (checkboxes.length > 0 && checkedCheckboxes.length === checkboxes.length);

        if (isCurrentlyAllSelected) {
            // СНИМАЕМ ВЫДЕЛЕНИЕ
            checkboxes.forEach(checkbox => {
                checkbox.checked = false;
            });

            // Удаляем сохраненные данные
            localStorage.removeItem('all_filtered_selected');
            localStorage.removeItem('all_filtered_count');

            showNotification('Выделение снято', 'info');
        } else {
            // ВЫБИРАЕМ ВСЕ ОТФИЛЬТРОВАННЫЕ

            // Получаем все ID отфильтрованных мероприятий
            const urlParams = new URLSearchParams(window.location.search);
            const response = await fetch(`{% url 'get_filtered_event_ids' %}?${urlParams.toString()}`);
            const data = await response.json();
            const allFilteredIds = data.event_ids || [];

            // Сохраняем в localStorage
            localStorage.setItem('all_filtered_selected', JSON.stringify(allFilteredIds));
            localStorage.setItem('all_filtered_count', allFilteredIds.length);

            // Отмечаем все отфильтрованные мероприятия на текущей странице
            checkboxes.forEach(checkbox => {
                const eventId = parseInt(checkbox.value);
                checkbox.checked = allFilteredIds.includes(eventId);
            });

            showNotification(`Выбрано ${allFilteredIds.length} отфильтрованных мероприятий`, 'success');
        }

    } catch (error) {
        console.error('Ошибка:', error);

        // Резервная логика: только текущая страница
        const checkboxes = document.querySelectorAll('.event-checkbox');
        const checkedCheckboxes = document.querySelectorAll('.event-checkbox:checked');
        const isCurrentlyAllSelected = checkboxes.length > 0 &&
                                      checkedCheckboxes.length === checkboxes.length;

        if (isCurrentlyAllSelected) {
            // Снимаем выделение
            checkboxes.forEach(checkbox => {
                checkbox.checked = false;
            });
            showNotification('Выделение снято', 'info');
        } else {
            // Выбираем все на текущей странице
            checkboxes.forEach(checkbox => {
                checkbox.checked = true;
            });
            showNotification(`Выбрано ${checkboxes.length} мероприятий на текущей странице`, 'warning');
        }

        // Сбрасываем флаг выбора всех отфильтрованных
        localStorage.removeItem('all_filtered_selected');
        localStorage.removeItem('all_filtered_count');

    } finally {
        selectAllBtn.innerHTML = originalText;
        selectAllBtn.disabled = false;
        updateSelectedCount();
        updateCustomCheckboxes();
    }
}

// Обновление счетчика выбранных мероприятий
function updateSelectedCount() {
    const checkboxes = document.querySelectorAll('.event-checkbox');
    const checkedCheckboxes = document.querySelectorAll('.event-checkbox:checked');
    const count = checkedCheckboxes.length;
    const totalCheckboxes = checkboxes.length;

    const selectedCountElement = document.getElementById('selectedCount');
    const allFilteredSelectedStr = localStorage.getItem('all_filtered_selected');
    const allFilteredCountStr = localStorage.getItem('all_filtered_count');

    let displayCount = count;
    let allFilteredSelected = false;

    // Проверяем, выбраны ли "все отфильтрованные"
    if (allFilteredSelectedStr && allFilteredCountStr) {
        try {
            const allFilteredIds = JSON.parse(allFilteredSelectedStr);
            const allFilteredCount = parseInt(allFilteredCountStr);

            // Если есть сохраненные ID и на странице выбраны мероприятия
            if (allFilteredCount > 0 && count > 0) {
                // Проверяем, что на текущей странице выбраны ВСЕ мероприятия
                // и они все есть в списке отфильтрованных
                const pageSelectedIds = Array.from(checkedCheckboxes).map(cb => parseInt(cb.value));
                const allIdsOnPage = Array.from(checkboxes).map(cb => parseInt(cb.value));

                // Все ли мероприятия на странице выбраны?
                const allOnPageSelected = pageSelectedIds.length === allIdsOnPage.length;

                // Все ли выбранные ID есть в отфильтрованных?
                const allSelectedAreFiltered = pageSelectedIds.every(id => allFilteredIds.includes(id));

                if (allOnPageSelected && allSelectedAreFiltered) {
                    allFilteredSelected = true;
                    displayCount = allFilteredCount;
                }
            }
        } catch (e) {
            console.error('Ошибка парсинга:', e);
        }
    }

    // Обновляем отображение счетчика
    if (allFilteredSelected) {
        selectedCountElement.textContent = `Выбрано: ${displayCount}`;
        selectedCountElement.style.color = '';
        selectedCountElement.style.fontWeight = 'bold';
    } else {
        selectedCountElement.textContent = `Выбрано: ${count}`;
        selectedCountElement.style.color = '';
        selectedCountElement.style.fontWeight = '';
    }

    // Обновляем флаг isSelectAll
    isSelectAll = allFilteredSelected || (count > 0 && count === totalCheckboxes);

    // Обновляем текст кнопки "Выбрать все"
    const selectAllText = document.getElementById('selectAllText');
    if (isSelectAll) {
        selectAllText.textContent = 'Снять выделение';
    } else {
        selectAllText.textContent = 'Выбрать все';
    }

    // Обновляем состояние кнопок массовых действий
    updateBulkActionsState(allFilteredSelected ? displayCount : count);

    // Обновляем визуальное состояние кастомных чекбоксов
    updateCustomCheckboxes();
}

// Обновление визуального состояния кастомных чекбоксов
function updateCustomCheckboxes() {
    const checkboxes = document.querySelectorAll('.event-checkbox');
    checkboxes.forEach(checkbox => {
        const label = checkbox.nextElementSibling;
        if (label && label.classList.contains('checkbox-label')) {
            const checkmark = label.querySelector('.checkmark');
            const labelText = label.querySelector('.label-text');

            if (checkbox.checked) {
                if (checkmark) {
                    checkmark.style.backgroundColor = '#e74c3c';
                    checkmark.style.borderColor = '#e74c3c';
                }
                if (labelText) {
                    labelText.style.color = '#e74c3c';
                    labelText.style.fontWeight = '600';
                }
            } else {
                if (checkmark) {
                    checkmark.style.backgroundColor = '';
                    checkmark.style.borderColor = '#95a5a6';
                }
                if (labelText) {
                    labelText.style.color = '#bdc3c7';
                    labelText.style.fontWeight = '';
                }
            }
        }
    });
}

// Обновление состояния кнопок массовых действий
function updateBulkActionsState(selectedCount) {
    const exportBtn = document.querySelector('.export-btn');
    const deleteBtn = document.querySelector('.delete-btn');

    const hasSelection = selectedCount > 0;

    exportBtn.disabled = !hasSelection;
    deleteBtn.disabled = !hasSelection;

    if (!hasSelection) {
        exportBtn.style.opacity = '0.6';
        exportBtn.style.cursor = 'not-allowed';
        deleteBtn.style.opacity = '0.6';
        deleteBtn.style.cursor = 'not-allowed';
    } else {
        exportBtn.style.opacity = '1';
        exportBtn.style.cursor = 'pointer';
        deleteBtn.style.opacity = '1';
        deleteBtn.style.cursor = 'pointer';
    }
}

// Показ модального окна подтверждения удаления
function showDeleteConfirm() {
    const checkboxes = document.querySelectorAll('.event-checkbox:checked');

    // Проверяем, выбраны ли "все отфильтрованные"
    const allFilteredSelectedStr = localStorage.getItem('all_filtered_selected');
    const allFilteredCountStr = localStorage.getItem('all_filtered_count');
    let allFilteredSelected = false;
    let allFilteredCount = 0;

    if (allFilteredSelectedStr && allFilteredCountStr) {
        try {
            const allFilteredIds = JSON.parse(allFilteredSelectedStr);
            allFilteredCount = parseInt(allFilteredCountStr);

            // Проверяем, выбраны ли все отфильтрованные мероприятия
            if (allFilteredCount > 0 && checkboxes.length > 0) {
                // Если на странице выбраны все мероприятия
                const allCheckboxes = document.querySelectorAll('.event-checkbox');
                if (checkboxes.length === allCheckboxes.length && allCheckboxes.length > 0) {
                    allFilteredSelected = true;
                }
            }
        } catch (e) {
            console.error('Ошибка парсинга:', e);
        }
    }

    if (!allFilteredSelected && checkboxes.length === 0) {
        showNotification('Пожалуйста, выберите хотя бы одно мероприятие для удаления', 'warning');
        return;
    }

    const deleteMessage = document.getElementById('deleteMessage');
    const eventsList = document.getElementById('deleteEventsList');
    const eventsToDelete = document.getElementById('eventsToDelete');

    eventsList.innerHTML = '';

    if (allFilteredSelected) {
        deleteMessage.textContent = `Вы уверены, что хотите удалить все отфильтрованные мероприятия (${allFilteredCount} шт.)?`;
        eventsToDelete.style.display = 'none';
    } else if (checkboxes.length === 1) {
        const eventName = checkboxes[0].dataset.eventName;
        deleteMessage.textContent = `Вы уверены, что хотите удалить мероприятие "${eventName}"?`;
        eventsToDelete.style.display = 'none';
    } else {
        deleteMessage.textContent = `Вы уверены, что хотите удалить ${checkboxes.length} мероприятий?`;
        eventsToDelete.style.display = 'block';

        // Ограничиваем показ до 10 мероприятий для читаемости
        const maxShown = 10;

        checkboxes.forEach((checkbox, index) => {
            if (index < maxShown) {
                const li = document.createElement('li');
                li.textContent = checkbox.dataset.eventName;
                eventsList.appendChild(li);
            }
        });

        // Показываем сколько еще мероприятий не отображается
        if (checkboxes.length > maxShown) {
            const li = document.createElement('li');
            li.textContent = `... и еще ${checkboxes.length - maxShown} мероприятий`;
            li.style.color = '#bdc3c7';
            li.style.fontStyle = 'italic';
            eventsList.appendChild(li);
        }
    }

    document.getElementById('deleteModal').style.display = 'block';
}

// Закрытие модального окна удаления
function closeDeleteModal() {
    document.getElementById('deleteModal').style.display = 'none';
}

// Удаление выбранных мероприятий
async function deleteSelectedEvents() {
    const checkboxes = document.querySelectorAll('.event-checkbox:checked');

    // Проверяем, выбраны ли "все отфильтрованные"
    const allFilteredSelectedStr = localStorage.getItem('all_filtered_selected');
    const allFilteredCountStr = localStorage.getItem('all_filtered_count');
    let allFilteredSelected = false;
    let allFilteredIds = [];

    if (allFilteredSelectedStr && allFilteredCountStr) {
        try {
            allFilteredIds = JSON.parse(allFilteredSelectedStr);
            const allFilteredCount = parseInt(allFilteredCountStr);

            // Проверяем, выбраны ли все отфильтрованные мероприятия
            if (allFilteredCount > 0 && checkboxes.length > 0) {
                // Если на странице выбраны все мероприятия
                const allCheckboxes = document.querySelectorAll('.event-checkbox');
                if (checkboxes.length === allCheckboxes.length && allCheckboxes.length > 0) {
                    allFilteredSelected = true;
                }
            }
        } catch (e) {
            console.error('Ошибка парсинга:', e);
        }
    }

    if (!allFilteredSelected && checkboxes.length === 0) {
        showNotification('Нет выбранных мероприятий для удаления', 'warning');
        return;
    }

    try {
        // Показываем индикатор загрузки
        const deleteBtn = document.querySelector('.delete-btn');
        const originalText = deleteBtn.innerHTML;
        deleteBtn.innerHTML = '<svg class="spinner" width="16" height="16" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none" opacity="0.25"/><path d="M12 2a10 10 0 0 1 10 10" stroke="currentColor" stroke-width="4" fill="none" stroke-linecap="round"/></svg> Удаление...';
        deleteBtn.disabled = true;

        // Создаем скрытую форму для отправки данных
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = "{% url 'bulk_delete_events' %}";

        const csrfToken = document.createElement('input');
        csrfToken.type = 'hidden';
        csrfToken.name = 'csrfmiddlewaretoken';
        csrfToken.value = '{{ csrf_token }}';
        form.appendChild(csrfToken);

        // Добавляем ID мероприятий
        if (allFilteredSelected) {
            // Добавляем все отфильтрованные ID
            allFilteredIds.forEach(id => {
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = 'selected_events';
                input.value = id;
                form.appendChild(input);
            });
        } else {
            // Добавляем только выбранные на текущей странице
            checkboxes.forEach(checkbox => {
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = 'selected_events';
                input.value = checkbox.value;
                form.appendChild(input);
            });
        }

        document.body.appendChild(form);
        form.submit();

    } catch (error) {
        console.error('Ошибка при удалении:', error);
        showNotification('Ошибка при удалении мероприятий', 'error');

        // Восстанавливаем кнопку
        const deleteBtn = document.querySelector('.delete-btn');
        if (deleteBtn) {
            deleteBtn.innerHTML = originalText;
            deleteBtn.disabled = false;
        }
    }
}

// Экспорт выбранных мероприятий
async function exportSelectedEvents(e) {
    e.preventDefault();

    const checkboxes = document.querySelectorAll('.event-checkbox:checked');

    // Проверяем, выбраны ли "все отфильтрованные"
    const allFilteredSelectedStr = localStorage.getItem('all_filtered_selected');
    const allFilteredCountStr = localStorage.getItem('all_filtered_count');
    let allFilteredSelected = false;
    let allFilteredIds = [];
    let allFilteredCount = 0;

    if (allFilteredSelectedStr && allFilteredCountStr) {
        try {
            allFilteredIds = JSON.parse(allFilteredSelectedStr);
            allFilteredCount = parseInt(allFilteredCountStr);

            // Проверяем, выбраны ли все отфильтрованные мероприятия
            if (allFilteredCount > 0 && checkboxes.length > 0) {
                // Если на странице выбраны все мероприятия
                const allCheckboxes = document.querySelectorAll('.event-checkbox');
                if (checkboxes.length === allCheckboxes.length && allCheckboxes.length > 0) {
                    allFilteredSelected = true;
                }
            }
        } catch (e) {
            console.error('Ошибка парсинга:', e);
        }
    }

    if (!allFilteredSelected && checkboxes.length === 0) {
        showNotification('Пожалуйста, выберите хотя бы одно мероприятие для экспорта', 'warning');
        return;
    }

    try {
        // Показываем индикатор загрузки
        const exportBtn = document.querySelector('.export-btn');
        const originalText = exportBtn.innerHTML;
        exportBtn.innerHTML = '<svg class="spinner" width="16" height="16" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none" opacity="0.25"/><path d="M12 2a10 10 0 0 1 10 10" stroke="currentColor" stroke-width="4" fill="none" stroke-linecap="round"/></svg> Экспорт...';
        exportBtn.disabled = true;

        // Создаем скрытую форму для отправки данных
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = "{% url 'export_selected_events' %}";
        form.style.display = 'none';

        const csrfToken = document.createElement('input');
        csrfToken.type = 'hidden';
        csrfToken.name = 'csrfmiddlewaretoken';
        csrfToken.value = '{{ csrf_token }}';
        form.appendChild(csrfToken);

        // Добавляем ID мероприятий
        if (allFilteredSelected) {
            // Добавляем все отфильтрованные ID
            allFilteredIds.forEach(id => {
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = 'selected_events';
                input.value = id;
                form.appendChild(input);
            });
        } else {
            // Добавляем только выбранные на текущей странице
            checkboxes.forEach(checkbox => {
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = 'selected_events';
                input.value = checkbox.value;
                form.appendChild(input);
            });
        }

        // Создаем iframe для скачивания файла
        const iframe = document.createElement('iframe');
        iframe.name = 'downloadFrame';
        iframe.style.display = 'none';
        document.body.appendChild(iframe);

        form.target = 'downloadFrame';

        document.body.appendChild(form);
        form.submit();

        if (allFilteredSelected) {
            showNotification(`Экспортируется ${allFilteredCount} отфильтрованных мероприятий`, 'info');
        } else {
            showNotification(`Экспортируется ${checkboxes.length} мероприятий`, 'info');
        }

        // Восстанавливаем кнопку через 2 секунды
        setTimeout(() => {
            exportBtn.innerHTML = originalText;
            exportBtn.disabled = false;
            updateBulkActionsState(allFilteredSelected ? allFilteredCount : checkboxes.length);
        }, 2000);

        // Убираем форму и iframe после отправки
        setTimeout(() => {
            if (form.parentNode) form.parentNode.removeChild(form);
            if (iframe.parentNode) iframe.parentNode.removeChild(iframe);
        }, 3000);

    } catch (error) {
        console.error('Ошибка при экспорте:', error);
        showNotification('Ошибка при экспорте мероприятий', 'error');

        // Восстанавливаем кнопку
        const exportBtn = document.querySelector('.export-btn');
        if (exportBtn) {
            exportBtn.innerHTML = originalText;
            exportBtn.disabled = false;
        }
    }
}

// Функция для показа уведомлений
function showNotification(message, type = 'info', duration = 5000) {
    // Удаляем предыдущие уведомления
    const existingNotification = document.getElementById('global-notification');
    if (existingNotification) {
        existingNotification.remove();
    }

    // Создаем новое уведомление
    const notification = document.createElement('div');
    notification.id = 'global-notification';
    notification.className = `notification notification-${type}`;
    notification.innerHTML = `
        <div class="notification-content">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                ${type === 'success' ? '<polyline points="20 6 9 17 4 12"></polyline>' :
                  type === 'error' ? '<circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line>' :
                  type === 'warning' ? '<path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line>' :
                  '<circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line>'}
            </svg>
            <span>${message}</span>
        </div>
        <button class="notification-close" onclick="this.parentElement.remove()">
            &times;
        </button>
    `;

    document.body.appendChild(notification);

    // Автоматическое скрытие
    if (duration > 0) {
        setTimeout(() => {
            if (notification.parentElement) {
                notification.remove();
            }
        }, duration);
    }

    return notification;
}

// Сбрасываем выбор при изменении фильтров
function resetSelection() {
    localStorage.removeItem('all_filtered_selected');
    localStorage.removeItem('all_filtered_count');
    isSelectAll = false;

    const checkboxes = document.querySelectorAll('.event-checkbox');
    checkboxes.forEach(checkbox => {
        checkbox.checked = false;
    });

    updateSelectedCount();
}

// Закрытие модального окна при клике вне его
window.addEventListener('click', (event) => {
    const modal = document.getElementById('deleteModal');
    if (event.target === modal) {
        closeDeleteModal();
    }
});

// Закрытие модального окна при нажатии Escape
document.addEventListener('keydown', (event) => {
    if (event.key === 'Escape') {
        closeDeleteModal();
    }
});

// Инициализация при загрузке страницы
document.addEventListener('DOMContentLoaded', function() {
    // Добавляем обработчики изменения для всех чекбоксов
    const checkboxes = document.querySelectorAll('.event-checkbox');
    checkboxes.forEach(checkbox => {
        checkbox.addEventListener('change', updateSelectedCount);
    });

    // Инициализируем счетчик и состояние чекбоксов
    updateSelectedCount();

    // Назначаем обработчики для кнопок
    const exportBtn = document.querySelector('.export-btn');
    const deleteBtn = document.querySelector('.delete-btn');
    const selectAllBtn = document.querySelector('.select-all-btn');

    if (exportBtn) exportBtn.addEventListener('click', exportSelectedEvents);
    if (deleteBtn) deleteBtn.addEventListener('click', showDeleteConfirm);
    if (selectAllBtn) selectAllBtn.addEventListener('click', toggleSelectAll);

    const closeModalBtn = document.querySelector('.close-modal');
    const confirmDeleteBtn = document.querySelector('.btn-danger');
    const cancelDeleteBtn = document.querySelector('.btn-secondary');

    if (closeModalBtn) closeModalBtn.addEventListener('click', closeDeleteModal);
    if (confirmDeleteBtn) confirmDeleteBtn.addEventListener('click', deleteSelectedEvents);
    if (cancelDeleteBtn) cancelDeleteBtn.addEventListener('click', closeDeleteModal);

    // Сбрасываем выбор при отправке формы фильтров
    const filterForm = document.getElementById('filterForm');
    if (filterForm) {
        filterForm.addEventListener('submit', function() {
            resetSelection();
        });
    }

    // Добавляем стиль для спиннера и уведомлений
    const style = document.createElement('style');
    style.textContent = `
        .spinner {
            animation: rotate 1s linear infinite;
            margin-right: 8px;
        }

        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .export-btn:disabled:hover,
        .delete-btn:disabled:hover {
            transform: none !important;
            box-shadow: none !important;
        }

        .event-checkbox {
            position: absolute;
            opacity: 0;
            width: 20px;
            height: 20px;
            cursor: pointer;
            z-index: 1;
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            cursor: pointer;
            font-size: 14px;
            color: #bdc3c7;
            transition: color 0.3s ease;
            position: relative;
        }

        .checkmark {
            width: 20px;
            height: 20px;
            border: 2px solid #95a5a6;
            border-radius: 4px;
            margin-right: 10px;
            position: relative;
            transition: all 0.3s ease;
        }

        .checkmark::after {
            content: '';
            position: absolute;
            display: none;
            left: 6px;
            top: 2px;
            width: 5px;
            height: 10px;
            border: solid #fff;
            border-width: 0 2px 2px 0;
            transform: rotate(45deg);
        }

        .event-checkbox:checked + .checkbox-label .checkmark {
            background-color: #e74c3c;
            border-color: #e74c3c;
        }

        .event-checkbox:checked + .checkbox-label .checkmark::after {
            display: block;
        }

        .event-checkbox:checked + .checkbox-label .label-text {
            color: #e74c3c;
            font-weight: 600;
        }

        /* Стили для уведомлений */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            min-width: 300px;
            max-width: 400px;
            background: linear-gradient(145deg, #2c3e50, #34495e);
            border-radius: 8px;
            padding: 16px 20px;
            border: 1px solid;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            animation: slideIn 0.3s ease-out;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .notification-success {
            border-color: #2ecc71;
        }

        .notification-error {
            border-color: #e74c3c;
        }

        .notification-info {
            border-color: #3498db;
        }

        .notification-warning {
            border-color: #f39c12;
        }

        .notification-content {
            display: flex;
            align-items: center;
            gap: 10px;
            flex: 1;
        }

        .notification-content svg {
            flex-shrink: 0;
        }

        .notification-close {
            background: none;
            border: none;
            color: #95a5a6;
            font-size: 20px;
            cursor: pointer;
            padding: 0 0 0 10px;
            transition: color 0.3s ease;
        }

        .notification-close:hover {
            color: #ecf0f1;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
    `;
    document.head.appendChild(style);

    // Отладочная информация
    console.log('Скрипт инициализирован. Найдено чекбоксов:', checkboxes.length);
});

// Вспомогательная функция для отладки
function debugSelection() {
    const checkboxes = document.querySelectorAll('.event-checkbox');
    const checked = document.querySelectorAll('.event-checkbox:checked');
    console.log('Всего чекбоксов:', checkboxes.length);
    console.log('Выбрано чекбоксов:', checked.length);
    console.log('Состояние isSelectAll:', isSelectAll);

    // Показываем состояние каждого чекбокса
    checkboxes.forEach((checkbox, index) => {
        console.log(`Чекбокс ${index}:`, {
            id: checkbox.id,
            checked: checkbox.checked,
            value: checkbox.value
        });
    });
}
    // Календарь для фильтров (только дата, без времени)
let calendarCurrentDate = new Date();
let calendarCurrentField = null;
let calendarDaysContainer = null;
let selectedCalendarDay = null;

function showCalendar(fieldId) {
  calendarCurrentField = document.getElementById(fieldId);

  // Если в поле уже есть значение, используем его
  if (calendarCurrentField.value) {
    const [year, month, day] = calendarCurrentField.value.split('-').map(Number);
    if (year && month && day) {
      // Создаем дату в UTC для избежания сдвига
      calendarCurrentDate = new Date(Date.UTC(year, month - 1, day));
    }
  } else {
    // Если нет значения, используем текущую дату
    const now = new Date();
    calendarCurrentDate = new Date(Date.UTC(now.getFullYear(), now.getMonth(), now.getDate()));
  }

  updateCalendarView();
  document.getElementById('calendarModal').style.display = 'block';

  // Выделяем сегодняшнюю дату по умолчанию (если нет другой выбранной)
  setTimeout(() => {
    if (calendarCurrentField.value) {
      // Выделяем дату из поля
      const [year, month, day] = calendarCurrentField.value.split('-').map(Number);
      const dateUTC = new Date(Date.UTC(year, month - 1, day));
      const dateString = dateUTC.toISOString().split('T')[0];
      const selectedElement = document.querySelector(`.calendar-day[data-date="${dateString}"]`);
      if (selectedElement) {
        document.querySelectorAll('.calendar-day').forEach(day => {
          day.classList.remove('selected');
        });
        selectedElement.classList.add('selected');
        selectedCalendarDay = selectedElement;
      }
    } else {
      // Выделяем сегодняшний день если нет выбранной даты
      const today = new Date();
      const todayUTC = new Date(Date.UTC(today.getFullYear(), today.getMonth(), today.getDate()));
      const todayString = todayUTC.toISOString().split('T')[0];
      const todayElement = document.querySelector(`.calendar-day[data-date="${todayString}"]`);
      if (todayElement && !selectedCalendarDay) {
        document.querySelectorAll('.calendar-day').forEach(day => {
          day.classList.remove('selected');
        });
        todayElement.classList.add('selected');
        selectedCalendarDay = todayElement;
      }
    }
  }, 100);
}

function closeCalendar() {
  document.getElementById('calendarModal').style.display = 'none';
}

function updateCalendarView() {
  const monthNames = [
    'Январь', 'Февраль', 'Март', 'Апрель', 'Май', 'Июнь',
    'Июль', 'Август', 'Сентябрь', 'Октябрь', 'Ноябрь', 'Декабрь'
  ];

  const year = calendarCurrentDate.getUTCFullYear();
  const month = calendarCurrentDate.getUTCMonth();

  document.getElementById('currentMonthYear').textContent =
    `${monthNames[month]} ${year}`;

  // Первый день месяца
  const firstDay = new Date(Date.UTC(year, month, 1));
  // Последний день месяца
  const lastDay = new Date(Date.UTC(year, month + 1, 0));
  // Первый день для отображения (может быть с прошлого месяца)
  const startDay = new Date(firstDay);
  startDay.setUTCDate(startDay.getUTCDate() - (firstDay.getUTCDay() + 6) % 7);

  calendarDaysContainer = document.querySelector('.calendar-days');
  // Очищаем предыдущие дни (кроме заголовков)
  while (calendarDaysContainer.children.length > 7) {
    calendarDaysContainer.removeChild(calendarDaysContainer.lastChild);
  }

  // Заполняем дни
  const tempDate = new Date(startDay);
  for (let i = 0; i < 42; i++) { // 6 недель × 7 дней
    const dayElement = document.createElement('div');
    dayElement.className = 'calendar-day';

    // Проверяем, относится ли день к текущему месяцу
    if (tempDate.getUTCMonth() !== month) {
      dayElement.classList.add('other-month');
    }

    // Проверяем, является ли день сегодняшним
    const today = new Date();
    const todayUTC = new Date(Date.UTC(today.getFullYear(), today.getMonth(), today.getDate()));
    const todayString = todayUTC.toISOString().split('T')[0];
    const dayString = tempDate.toISOString().split('T')[0];

    if (dayString === todayString) {
      dayElement.classList.add('today');
    }

    // Проверяем, является ли день выбранным
    if (calendarCurrentField && calendarCurrentField.value) {
      const [selectedYear, selectedMonth, selectedDay] = calendarCurrentField.value.split('-').map(Number);
      const selectedDateUTC = new Date(Date.UTC(selectedYear, selectedMonth - 1, selectedDay));
      const selectedDateString = selectedDateUTC.toISOString().split('T')[0];

      if (dayString === selectedDateString) {
        dayElement.classList.add('selected');
        selectedCalendarDay = dayElement;
      }
    }

    dayElement.textContent = tempDate.getUTCDate();
    dayElement.dataset.date = tempDate.toISOString().split('T')[0];

    dayElement.addEventListener('click', () => {
      // Убираем выделение со всех дней
      document.querySelectorAll('.calendar-day').forEach(day => {
        day.classList.remove('selected');
      });
      // Выделяем выбранный день
      dayElement.classList.add('selected');
      selectedCalendarDay = dayElement;

      // Обновляем calendarCurrentDate на выбранную дату
      const dateStr = dayElement.dataset.date;
      const [y, m, d] = dateStr.split('-').map(Number);
      calendarCurrentDate = new Date(Date.UTC(y, m - 1, d));
    });

    calendarDaysContainer.appendChild(dayElement);
    tempDate.setUTCDate(tempDate.getUTCDate() + 1);
  }
}

function changeMonth(delta) {
  const year = calendarCurrentDate.getUTCFullYear();
  const month = calendarCurrentDate.getUTCMonth();
  calendarCurrentDate = new Date(Date.UTC(year, month + delta, 1));
  updateCalendarView();
  selectedCalendarDay = null; // Сбрасываем выбранный день при смене месяца
}

function setToday() {
  const today = new Date();

  // Используем локальную дату для отображения, но UTC для сохранения
  const year = today.getFullYear();
  const month = today.getMonth();
  const day = today.getDate();

  calendarCurrentDate = new Date(Date.UTC(year, month, day));
  updateCalendarView();

  // Выделяем сегодняшний день
  setTimeout(() => {
    const todayUTC = new Date(Date.UTC(year, month, day));
    const todayString = todayUTC.toISOString().split('T')[0];
    const todayElement = document.querySelector(`.calendar-day[data-date="${todayString}"]`);
    if (todayElement) {
      document.querySelectorAll('.calendar-day').forEach(day => {
        day.classList.remove('selected');
      });
      todayElement.classList.add('selected');
      selectedCalendarDay = todayElement;
    }
  }, 100);
}

function setSelectedDate() {
  if (!calendarCurrentField || !selectedCalendarDay) return;

  const selectedDate = new Date(selectedCalendarDay.dataset.date);

  // Исправляем проблему часового пояса
  // Используем UTC, чтобы избежать сдвига даты
  const year = selectedDate.getUTCFullYear();
  const month = (selectedDate.getUTCMonth() + 1).toString().padStart(2, '0');
  const day = selectedDate.getUTCDate().toString().padStart(2, '0');

  calendarCurrentField.value = `${year}-${month}-${day}`;
  closeCalendar();

  console.log('Выбрана дата:', calendarCurrentField.value); // Для отладки
}

// Закрытие календаря при клике вне его
window.addEventListener('click', (event) => {
  const modal = document.getElementById('calendarModal');
  if (event.target === modal) {
    closeCalendar();
  }
});

// Закрытие календаря при нажатии Escape
document.addEventListener('keydown', (event) => {
  if (event.key === 'Escape') {
    closeCalendar();
  }
});

// Инициализация календаря при загрузке страницы
document.addEventListener('DOMContentLoaded', function() {
  // Обновляем календарь при загрузке
  updateCalendarView();

  // Скрываем встроенный календарь браузера
  const dateInputs = document.querySelectorAll('input[type="date"]');
  dateInputs.forEach(input => {
    // Добавляем placeholder
    input.addEventListener('focus', function() {
      this.type = 'text';
      this.blur();
      setTimeout(() => {
        this.type = 'date';
      }, 100);
    });
  });
});

// Функция для форматирования дат в списке мероприятий
function formatEventDates() {
    const eventDates = document.querySelectorAll('.event-date');

    eventDates.forEach(element => {
        const text = element.textContent;

        // Ищем паттерн дат в формате "2032-12-22T19:32 - 2032-12-22T21:32"
        const regex = /(\d{4}-\d{2}-\d{2}T\d{2}:\d{2})\s*[—\-]\s*(\d{4}-\d{2}-\d{2}T\d{2}:\d{2})/g;
        const matches = [...text.matchAll(regex)];

        if (matches.length > 0) {
            let formattedText = text;

            matches.forEach(match => {
                const [fullMatch, start, end] = match;

                // Форматируем даты
                const formattedStart = formatDateForDisplay(start);
                const formattedEnd = formatDateForDisplay(end);

                // Заменяем в тексте
                formattedText = formattedText.replace(
                    fullMatch,
                    `${formattedStart} — ${formattedEnd}`
                );
            });

            element.innerHTML = formattedText;
        }
    });
}

// Запускаем при загрузке страницы
document.addEventListener('DOMContentLoaded', function() {
    formatEventDates();
});




</script>











  <style>
  /* Стили для кнопки создания мероприятия */
  .create-event-section {
    margin-bottom: 30px;
  }

  .create-event-btn {
    display: inline-flex;
    align-items: center;
    padding: 14px 28px;
    background: linear-gradient(135deg, #1abc9c 0%, #16a085 100%);
    color: white;
    text-decoration: none;
    border-radius: 10px;
    font-size: 16px;
    font-weight: 600;
    transition: all 0.3s ease;
    border: none;
    cursor: pointer;
  }

  .create-event-btn:hover {
    transform: translateY(-3px);
    box-shadow: 0 10px 20px rgba(26, 188, 156, 0.4);
    color: white;
    text-decoration: none;
  }

  .create-event-btn svg {
    stroke: white;
  }

  /* Стили для массовых действий */
  .bulk-actions {
    margin: 20px 0;
    padding: 20px;
    background: linear-gradient(145deg, #2c3e50, #34495e);
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex-wrap: wrap;
    gap: 15px;
    border: 1px solid #4a5f7a;
  }

  .export-btn, .delete-btn, .select-all-btn {
    display: inline-flex;
    align-items: center;
    padding: 12px 20px;
    border: none;
    border-radius: 8px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    text-decoration: none;
    font-family: inherit;
  }

  .export-btn {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
  }

  .export-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
  }

  .delete-btn {
    background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
    color: white;
  }

  .delete-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(231, 76, 60, 0.4);
  }

  .select-all-btn {
    background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
    color: white;
  }

  .select-all-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(52, 152, 219, 0.4);
  }

  .selection-controls {
    display: flex;
    align-items: center;
    gap: 15px;
  }

  .selected-count {
    color: #ecf0f1;
    font-size: 14px;
    font-weight: 600;
    background: rgba(26, 188, 156, 0.1);
    padding: 8px 16px;
    border-radius: 20px;
    border: 1px solid rgba(26, 188, 156, 0.3);
  }

  /* Стили для фильтрации */
  form[action*="events_ui"] {
    background: linear-gradient(145deg, #2c3e50, #34495e);
    padding: 25px;
    border-radius: 12px;
    margin-bottom: 25px;
    border: 1px solid #4a5f7a;
  }

  form[action*="events_ui"] label {
    color: #ecf0f1;
    font-weight: 600;
    margin-right: 12px;
    margin-bottom: 8px;
    display: inline-block;
  }

  form[action*="events_ui"] input,
  form[action*="events_ui"] select {
    padding: 10px 14px;
    border-radius: 6px;
    border: 1px solid #4a5f7a;
    background: #1a2530;
    color: #ecf0f1;
    margin-right: 15px;
    margin-bottom: 12px;
    transition: all 0.3s ease;
  }

  form[action*="events_ui"] input:focus,
  form[action*="events_ui"] select:focus {
    outline: none;
    border-color: #1abc9c;
    box-shadow: 0 0 0 3px rgba(26, 188, 156, 0.2);
  }

  form[action*="events_ui"] button[type="submit"] {
    padding: 12px 24px;
    background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
    color: white;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-size: 16px;
    font-weight: 600;
    transition: all 0.3s ease;
  }

  form[action*="events_ui"] button[type="submit"]:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(52, 152, 219, 0.4);
  }

  /* Стили для модального окна удаления */
  .modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.7);
    animation: fadeIn 0.3s ease-out;
  }

  .modal-content {
    background: linear-gradient(145deg, #2c3e50, #34495e);
    margin: 10% auto;
    padding: 0;
    border-radius: 16px;
    width: 90%;
    max-width: 500px;
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);
    border: 1px solid #4a5f7a;
    overflow: hidden;
  }

  .modal-header {
    background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
    padding: 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .modal-header h3 {
    margin: 0;
    color: white;
    font-weight: 600;
    font-size: 20px;
  }

  .close-modal {
    background: none;
    border: none;
    color: white;
    font-size: 28px;
    cursor: pointer;
    padding: 0;
    width: 30px;
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: transform 0.3s ease;
  }

  .close-modal:hover {
    transform: scale(1.2);
  }

  .modal-body {
    padding: 30px;
    color: #ecf0f1;
  }

  .modal-body p {
    margin: 0 0 20px 0;
    font-size: 16px;
    line-height: 1.5;
  }

  .events-list-delete {
    margin-top: 20px;
    padding: 15px;
    background: rgba(255, 255, 255, 0.05);
    border-radius: 8px;
    border: 1px solid rgba(255, 255, 255, 0.1);
  }

  .events-list-delete h4 {
    margin: 0 0 10px 0;
    color: #ecf0f1;
    font-size: 16px;
    font-weight: 600;
  }

  .events-list-delete ul {
    margin: 0;
    padding-left: 20px;
    max-height: 200px;
    overflow-y: auto;
  }

  .events-list-delete li {
    margin: 5px 0;
    color: #bdc3c7;
    font-size: 14px;
    padding: 5px 0;
    border-bottom: 1px dashed rgba(255, 255, 255, 0.1);
  }

  .events-list-delete li:last-child {
    border-bottom: none;
  }

  .modal-footer {
    padding: 20px;
    display: flex;
    justify-content: flex-end;
    gap: 15px;
    border-top: 1px solid #4a5f7a;
    background: rgba(255, 255, 255, 0.05);
  }

  .modal-footer .btn {
    min-width: 120px;
  }

  /* Анимации */
  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: translateY(-20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  /* Стили для событий */
  .events-list {
    display: flex;
    flex-direction: column;
    gap: 25px;
    margin-top: 20px;
  }

  .event-card {
    background: linear-gradient(145deg, #2c3e50, #34495e);
    color: white;
    border-radius: 12px;
    box-shadow: 0 6px 15px rgba(0, 0, 0, 0.2);
    padding: 25px;
    width: 100%;
    box-sizing: border-box;
    border: 1px solid #4a5f7a;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
  }

  .event-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 4px;
    height: 100%;
    background: linear-gradient(to bottom, #1abc9c, #3498db);
  }

  .event-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 12px 20px rgba(0, 0, 0, 0.25);
    border-color: #1abc9c;
  }

  .event-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 20px;
    padding-bottom: 15px;
    border-bottom: 1px solid #4a5f7a;
  }

  .event-title-section {
    flex: 1;
    padding-right: 50px;
  }

  .event-title {
    margin: 0;
    font-size: 20px;
    color: #fff;
    font-weight: 600;
    line-height: 1.3;
    margin-bottom: 5px;
  }

  .event-date {
    font-size: 14px;
    color: #95a5a6;
    margin: 0;
    font-weight: 500;
  }

  .event-actions {
    position: absolute;
    top: 25px;
    right: 25px;
  }

  .edit-icon {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: rgba(26, 188, 156, 0.15);
    transition: all 0.3s ease;
    border: 2px solid rgba(26, 188, 156, 0.3);
  }

  .edit-icon:hover {
    background: rgba(26, 188, 156, 0.3);
    border-color: #1abc9c;
    transform: scale(1.1) rotate(5deg);
  }

  .edit-icon svg {
    transition: all 0.3s ease;
  }

  .edit-icon:hover svg {
    stroke: #fff;
    transform: scale(1.1);
  }

  .event-details-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 15px;
    margin-bottom: 20px;
  }

  .detail-item {
    display: flex;
    align-items: flex-start;
    padding: 12px;
    background: rgba(255, 255, 255, 0.05);
    border-radius: 8px;
    border: 1px solid rgba(255, 255, 255, 0.1);
    transition: all 0.2s ease;
  }

  .detail-item:hover {
    background: rgba(255, 255, 255, 0.08);
    border-color: rgba(26, 188, 156, 0.3);
  }

  .detail-item.full-width {
    grid-column: 1 / -1;
  }

  .detail-icon {
    margin-right: 12px;
    padding-top: 2px;
    flex-shrink: 0;
  }

  .detail-content {
    display: flex;
    flex-direction: column;
    flex: 1;
    min-width: 0;
  }

  .detail-label {
    font-size: 12px;
    color: #95a5a6;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 4px;
  }

  .detail-value {
    font-size: 14px;
    color: #ecf0f1;
    line-height: 1.4;
    word-break: break-word;
  }

  .event-footer {
    padding-top: 20px;
    border-top: 1px solid #4a5f7a;
  }

  .checkbox-container {
    display: flex;
    align-items: center;
    cursor: pointer;
  }

  .event-checkbox {
    display: none;
  }

  .checkbox-label {
    display: flex;
    align-items: center;
    cursor: pointer;
    font-size: 14px;
    color: #bdc3c7;
    transition: color 0.3s ease;
  }

  .checkbox-label:hover {
    color: #1abc9c;
  }

  .checkmark {
    width: 20px;
    height: 20px;
    border: 2px solid #95a5a6;
    border-radius: 4px;
    margin-right: 10px;
    position: relative;
    transition: all 0.3s ease;
  }

  .checkmark::after {
    content: '';
    position: absolute;
    display: none;
    left: 6px;
    top: 2px;
    width: 5px;
    height: 10px;
    border: solid #fff;
    border-width: 0 2px 2px 0;
    transform: rotate(45deg);
  }

  .event-checkbox:checked + .checkbox-label .checkmark {
    background-color: #e74c3c;
    border-color: #e74c3c;
  }

  .event-checkbox:checked + .checkbox-label .checkmark::after {
    display: block;
  }

  .event-checkbox:checked + .checkbox-label .label-text {
    color: #e74c3c;
    font-weight: 600;
  }

  .empty-state {
    text-align: center;
    padding: 60px 20px;
    background: rgba(255, 255, 255, 0.05);
    border-radius: 12px;
    border: 2px dashed #4a5f7a;
  }

  .empty-state svg {
    margin-bottom: 20px;
  }

  .empty-state p {
    color: #95a5a6;
    font-size: 18px;
    margin: 0;
  }

  .pagination {
    text-align: center;
    margin-top: 40px;
    padding: 20px 0;
  }

  .step-links a {
    display: inline-flex;
    align-items: center;
    padding: 8px 16px;
    margin: 0 5px;
    background: #2c3e50;
    color: #ecf0f1;
    text-decoration: none;
    border-radius: 6px;
    border: 1px solid #4a5f7a;
    transition: all 0.3s ease;
  }

  .step-links a:hover {
    background: #34495e;
    color: #1abc9c;
    border-color: #1abc9c;
    transform: translateY(-1px);
  }

  .current {
    font-weight: 600;
    color: #ecf0f1;
    margin: 0 15px;
    padding: 8px 16px;
    background: rgba(26, 188, 156, 0.1);
    border-radius: 6px;
  }

  /* Стили для статистики */
  .statistics-section {
    margin-bottom: 30px;
  }

  .statistics-cards {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    gap: 20px;
    margin-bottom: 25px;
  }

  .stat-card {
    background: linear-gradient(145deg, #2c3e50, #34495e);
    border-radius: 12px;
    padding: 20px;
    display: flex;
    align-items: center;
    border: 1px solid #4a5f7a;
    transition: all 0.3s ease;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
  }

  .stat-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 15px rgba(0, 0, 0, 0.2);
    border-color: #1abc9c;
  }

  .stat-icon {
    width: 50px;
    height: 50px;
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 15px;
    flex-shrink: 0;
  }

  .stat-content {
    flex: 1;
  }

  .stat-number {
    margin: 0;
    font-size: 24px;
    font-weight: 700;
    color: #ecf0f1;
    line-height: 1.2;
  }

  .stat-label {
    margin: 5px 0 0 0;
    font-size: 14px;
    color: #95a5a6;
    font-weight: 500;
  }

  /* Стили для расширенной фильтрации */
  .advanced-filters {
    background: linear-gradient(145deg, #2c3e50, #34495e);
    padding: 25px;
    border-radius: 12px;
    margin-bottom: 25px;
    border: 1px solid #4a5f7a;
  }

  .filters-grid {
    display: flex;
    flex-direction: column;
    gap: 20px;
  }

  .filter-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
  }

  .filter-group {
    display: flex;
    flex-direction: column;
  }

  .filter-group.search-group {
    grid-column: 1 / -1;
  }

  .filter-group label {
    color: #ecf0f1;
    font-weight: 600;
    margin-bottom: 8px;
    font-size: 14px;
  }

  .search-container {
    position: relative;
    display: flex;
    align-items: center;
  }

  .search-container svg {
    position: absolute;
    left: 12px;
    top: 50%;
    transform: translateY(-50%);
    pointer-events: none;
  }

  .search-input {
    width: 100%;
    padding: 12px 12px 12px 40px;
    border-radius: 8px;
    border: 1px solid #4a5f7a;
    background: #1a2530;
    color: #ecf0f1;
    font-size: 16px;
    transition: all 0.3s ease;
  }

  .search-input:focus {
    outline: none;
    border-color: #1abc9c;
    box-shadow: 0 0 0 3px rgba(26, 188, 156, 0.2);
  }

  .filter-select, .filter-input {
    padding: 12px;
    border-radius: 8px;
    border: 1px solid #4a5f7a;
    background: #1a2530;
    color: #ecf0f1;
    font-size: 16px;
    transition: all 0.3s ease;
    width: 100%;
  }

  .filter-select:focus, .filter-input:focus {
    outline: none;
    border-color: #1abc9c;
    box-shadow: 0 0 0 3px rgba(26, 188, 156, 0.2);
  }

  .filter-actions {
    display: flex;
    justify-content: flex-start;
    align-items: center;
    gap: 15px;
    margin-top: 20px;
    padding-top: 20px;
    border-top: 1px solid #4a5f7a;
  }

  .filter-btn {
    display: inline-flex;
    align-items: center;
    padding: 12px 24px;
    background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
    color: white;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-size: 16px;
    font-weight: 600;
    transition: all 0.3s ease;
  }

  .filter-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(52, 152, 219, 0.4);
  }

  .clear-filters {
    display: inline-flex;
    align-items: center;
    padding: 12px 16px;
    background: #95a5a6;
    color: white;
    text-decoration: none;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 600;
    transition: all 0.3s ease;
  }

  .clear-filters:hover {
    background: #7f8c8d;
    color: white;
    text-decoration: none;
  }

  /* Стили для быстрых фильтров */
  .quick-filters-row {
    grid-column: 1 / -1;
  }

  .quick-filters {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-top: 5px;
  }

  .quick-filter-btn {
    padding: 8px 16px;
    background: #2c3e50;
    color: #ecf0f1;
    border-radius: 20px;
    text-decoration: none;
    font-size: 14px;
    font-weight: 500;
    border: 1px solid #4a5f7a;
    transition: all 0.3s ease;
  }

  .quick-filter-btn:hover {
    background: #34495e;
    border-color: #1abc9c;
    color: #1abc9c;
    transform: translateY(-2px);
  }

  .quick-filter-btn.active {
    background: linear-gradient(135deg, #1abc9c 0%, #16a085 100%);
    border-color: #1abc9c;
    color: white;
    font-weight: 600;
    box-shadow: 0 4px 8px rgba(26, 188, 156, 0.3);
  }

  /* Стили для уведомлений */
  .notification {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 10000;
    min-width: 300px;
    max-width: 400px;
    background: linear-gradient(145deg, #2c3e50, #34495e);
    border-radius: 8px;
    padding: 16px 20px;
    border: 1px solid;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    animation: slideIn 0.3s ease-out;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .notification-success {
    border-color: #2ecc71;
  }

  .notification-error {
    border-color: #e74c3c;
  }

  .notification-info {
    border-color: #3498db;
  }

  .notification-warning {
    border-color: #f39c12;
  }

  .notification-content {
    display: flex;
    align-items: center;
    gap: 10px;
    flex: 1;
  }

  .notification-content svg {
    flex-shrink: 0;
  }

  .notification-close {
    background: none;
    border: none;
    color: #95a5a6;
    font-size: 20px;
    cursor: pointer;
    padding: 0 0 0 10px;
    transition: color 0.3s ease;
  }

  .notification-close:hover {
    color: #ecf0f1;
  }

  @keyframes slideIn {
    from {
      transform: translateX(100%);
      opacity: 0;
    }
    to {
      transform: translateX(0);
      opacity: 1;
    }
  }

  /* Адаптивность */
  @media (max-width: 768px) {
    .bulk-actions {
      flex-direction: column;
      align-items: stretch;
    }

    .export-btn, .delete-btn, .select-all-btn {
      width: 100%;
      justify-content: center;
    }

    .selection-controls {
      justify-content: space-between;
      width: 100%;
    }

    .event-details-grid {
      grid-template-columns: 1fr;
    }

    .event-header {
      flex-direction: column;
    }

    .event-title-section {
      padding-right: 0;
      margin-bottom: 15px;
    }

    .event-actions {
      position: static;
      align-self: flex-end;
    }

    .modal-content {
      margin: 5% auto;
      width: 95%;
    }

    .create-event-btn {
      width: 100%;
      justify-content: center;
    }

    .statistics-cards {
      grid-template-columns: repeat(2, 1fr);
    }

    .filter-row {
      grid-template-columns: 1fr;
    }

    .filter-group.search-group {
      grid-column: auto;
    }

    .filter-actions {
      flex-direction: column;
      align-items: stretch;
    }

    .filter-btn, .clear-filters {
      width: 100%;
      justify-content: center;
    }

    .notification {
      left: 10px;
      right: 10px;
      width: calc(100% - 20px);
      max-width: none;
    }
  }

  @media (max-width: 480px) {
    .modal-body {
      padding: 20px;
    }

    .modal-footer {
      flex-direction: column;
      gap: 10px;
    }

    .modal-footer .btn {
      width: 100%;
      min-width: auto;
    }

    form[action*="events_ui"] {
      padding: 15px;
    }

    form[action*="events_ui"] input,
    form[action*="events_ui"] select {
      width: 100%;
      margin-right: 0;
      margin-bottom: 15px;
    }

    .statistics-cards {
      grid-template-columns: 1fr;
    }

    .stat-card {
      padding: 15px;
    }

    .stat-icon {
      width: 40px;
      height: 40px;
      margin-right: 12px;
    }

    .stat-number {
      font-size: 20px;
    }

    .quick-filters {
      justify-content: center;
    }

    .quick-filter-btn {
      padding: 6px 12px;
      font-size: 12px;
    }
  }
  /* Стили для контейнера даты в фильтрах */
.datetime-container {
    position: relative;
    display: flex;
    width: 100%;
}

.filter-input[type="date"] {
    width: 100%;
    padding-right: 50px;
}

.datetime-btn {
    position: absolute;
    right: 4px;
    top: 50%;
    transform: translateY(-50%);
    background: rgba(26, 188, 156, 0.1);
    border: 2px solid #4a5f7a;
    border-radius: 8px;
    color: #ecf0f1;
    padding: 8px 12px;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 2;
}

.datetime-btn:hover {
    background: rgba(26, 188, 156, 0.2);
    border-color: #1abc9c;
    transform: translateY(-50%) scale(1.05);
}

.datetime-btn svg {
    stroke: #1abc9c;
}

/* Стили для календаря (фильтры) */
.calendar-modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.7);
    animation: fadeIn 0.3s ease-out;
}

.calendar-content {
    background: linear-gradient(145deg, #2c3e50, #34495e);
    margin: 10% auto;
    padding: 0;
    border-radius: 16px;
    width: 90%;
    max-width: 500px;
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);
    border: 1px solid #4a5f7a;
    overflow: hidden;
}

.calendar-header {
    background: linear-gradient(135deg, #1abc9c 0%, #16a085 100%);
    padding: 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.calendar-header h3 {
    margin: 0;
    color: white;
    font-weight: 600;
}

.close-calendar {
    background: none;
    border: none;
    color: white;
    font-size: 28px;
    cursor: pointer;
    padding: 0;
    width: 30px;
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: transform 0.3s ease;
}

.close-calendar:hover {
    transform: scale(1.2);
}

.calendar-body {
    padding: 20px;
}

.calendar-month-year {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 20px;
    background: rgba(255, 255, 255, 0.05);
    padding: 10px;
    border-radius: 10px;
}

.calendar-month-year span {
    color: #ecf0f1;
    font-size: 18px;
    font-weight: 600;
}

.calendar-nav {
    background: rgba(26, 188, 156, 0.1);
    border: 2px solid #4a5f7a;
    border-radius: 8px;
    color: #ecf0f1;
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.3s ease;
    font-size: 20px;
}

.calendar-nav:hover {
    background: rgba(26, 188, 156, 0.2);
    border-color: #1abc9c;
    transform: scale(1.1);
}

.calendar-days {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 8px;
    margin-bottom: 20px;
}

.day-header {
    color: #95a5a6;
    font-weight: 600;
    font-size: 14px;
    text-align: center;
    padding: 10px 0;
    text-transform: uppercase;
}

.calendar-day {
    color: #ecf0f1;
    text-align: center;
    padding: 12px 0;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s ease;
    font-weight: 500;
    border: 2px solid transparent;
}

.calendar-day:hover {
    background: rgba(26, 188, 156, 0.1);
    border-color: #4a5f7a;
    transform: scale(1.05);
}

.calendar-day.selected {
    background: linear-gradient(135deg, #1abc9c 0%, #16a085 100%);
    color: white;
    border-color: #1abc9c;
    font-weight: 600;
}

.calendar-day.today {
    border: 2px solid #3498db;
}

.calendar-day.other-month {
    color: #7f8c8d;
    opacity: 0.5;
}

.calendar-footer {
    padding: 20px;
    display: flex;
    justify-content: space-between;
    border-top: 1px solid #4a5f7a;
    background: rgba(255, 255, 255, 0.05);
}

.calendar-footer .btn {
    min-width: 120px;
}

/* Кастомные стили для даты */
input[type="date"]::-webkit-calendar-picker-indicator {
    opacity: 0;
    position: absolute;
    width: 100%;
    height: 100%;
    cursor: pointer;
}

/* Подсказка для полей даты */
.datetime-container input[type="date"]::before {
    content: 'дд.мм.гггг';
    color: #95a5a6;
    position: absolute;
    left: 16px;
    top: 50%;
    transform: translateY(-50%);
    pointer-events: none;
}

.datetime-container input[type="date"]:focus::before,
.datetime-container input[type="date"]:not(:placeholder-shown)::before {
    display: none;
}

/* Адаптивность календаря */
@media (max-width: 768px) {
    .calendar-content {
        margin: 5% auto;
        width: 95%;
    }

    .calendar-day {
        padding: 8px 0;
    }

    .calendar-footer .btn {
        min-width: auto;
        padding: 10px 15px;
    }
}

@media (max-width: 480px) {
    .calendar-day {
        padding: 6px 0;
        font-size: 14px;
    }
}
/* Стили для календаря фильтров */
.calendar-modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.7);
    animation: fadeIn 0.3s ease-out;
}

.calendar-content {
    background: linear-gradient(145deg, #2c3e50, #34495e);
    margin: 10% auto;
    padding: 0;
    border-radius: 16px;
    width: 90%;
    max-width: 500px;
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);
    border: 1px solid #4a5f7a;
    overflow: hidden;
}

.calendar-header {
    background: linear-gradient(135deg, #1abc9c 0%, #16a085 100%);
    padding: 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.calendar-header h3 {
    margin: 0;
    color: white;
    font-weight: 600;
}

.close-calendar {
    background: none;
    border: none;
    color: white;
    font-size: 28px;
    cursor: pointer;
    padding: 0;
    width: 30px;
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: transform 0.3s ease;
}

.close-calendar:hover {
    transform: scale(1.2);
}

.calendar-body {
    padding: 20px;
}

.calendar-month-year {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 20px;
    background: rgba(255, 255, 255, 0.05);
    padding: 10px;
    border-radius: 10px;
}

.calendar-month-year span {
    color: #ecf0f1;
    font-size: 18px;
    font-weight: 600;
}

.calendar-nav {
    background: rgba(26, 188, 156, 0.1);
    border: 2px solid #4a5f7a;
    border-radius: 8px;
    color: #ecf0f1;
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.3s ease;
    font-size: 20px;
}

.calendar-nav:hover {
    background: rgba(26, 188, 156, 0.2);
    border-color: #1abc9c;
    transform: scale(1.1);
}

.calendar-days {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 8px;
    margin-bottom: 20px;
}

.day-header {
    color: #95a5a6;
    font-weight: 600;
    font-size: 14px;
    text-align: center;
    padding: 10px 0;
    text-transform: uppercase;
}

.calendar-day {
    color: #ecf0f1;
    text-align: center;
    padding: 12px 0;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s ease;
    font-weight: 500;
    border: 2px solid transparent;
}

.calendar-day:hover {
    background: rgba(26, 188, 156, 0.1);
    border-color: #4a5f7a;
    transform: scale(1.05);
}

.calendar-day.selected {
    background: linear-gradient(135deg, #1abc9c 0%, #16a085 100%);
    color: white;
    border-color: #1abc9c;
    font-weight: 600;
}

.calendar-day.today {
    border: 2px solid #3498db;
}

.calendar-day.other-month {
    color: #7f8c8d;
    opacity: 0.5;
}

.calendar-footer {
    padding: 20px;
    display: flex;
    justify-content: space-between;
    border-top: 1px solid #4a5f7a;
    background: rgba(255, 255, 255, 0.05);
}

.calendar-footer .btn {
    min-width: 120px;
}

/* Скрыть встроенный календарь браузера */
input[type="date"]::-webkit-calendar-picker-indicator {
    opacity: 0;
    width: 100%;
    height: 100%;
    position: absolute;
    right: 0;
    top: 0;
    cursor: pointer;
}

/* Стили для кнопок в фильтрах */
.datetime-btn {
    position: absolute;
    right: 4px;
    top: 50%;
    transform: translateY(-50%);
    background: rgba(26, 188, 156, 0.1);
    border: 2px solid #4a5f7a;
    border-radius: 8px;
    color: #ecf0f1;
    padding: 8px 12px;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 2;
}

.datetime-btn:hover {
    background: rgba(26, 188, 156, 0.2);
    border-color: #1abc9c;
    transform: translateY(-50%) scale(1.05);
}

.datetime-btn svg {
    stroke: #1abc9c;
}

/* Подсказка для полей даты */
input[type="date"]::before {
    content: 'дд.мм.гггг';
    color: #95a5a6;
    position: absolute;
    left: 16px;
    top: 50%;
    transform: translateY(-50%);
    pointer-events: none;
}

input[type="date"]:focus::before,
input[type="date"]:not(:placeholder-shown)::before {
    display: none;
}

/* Анимация появления календаря */
@keyframes fadeIn {
    from {
        opacity: 0;
        transform: translateY(-20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}


  </style>
{% endblock %}